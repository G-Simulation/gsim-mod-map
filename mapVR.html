<!DOCTYPE html>

<html id="html" lang="en">

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Map</title>

    <script src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>
    <script src="./leaflet/easy-button.js"></script>
    <script src="./leaflet/leaflet.groupedlayercontrol.min.js"></script>
    <script src="./leaflet/jquery.min.js"></script>
    <script src="./leaflet/leaflet.edgebuffer.js"></script>
    <script src="./leaflet/geosearch.js"></script>
    <script src="./leaflet/leaflet-hash.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="./leaflet/easy-button.css" />
    <link rel="stylesheet" href="./leaflet/leaflet.groupedlayercontrol.min.css" />
    <link rel="stylesheet" href="./leaflet/geosearch.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin="" />
    <link href='https://unpkg.com/css.gg@2.0.0/icons/css/airplane.css' rel='stylesheet'>

    <style>
        @font-face {
            font-family: "Roboto-Light";
            src: url("./Fonts/Roboto-Light.ttf") format("truetype");
            font-weight: normal;
            font-style: normal;
        }

        @media only screen and (-webkit-min-device-pixel-ratio : 2), only screen and (min-device-pixel-ratio : 2) {
            .wpHeader {
                font-size: 30px;
            }

            td#start, td#target {
                font-size: 50px;
            }
        }

        * {
            font-family: "Roboto-Light" !important;
        }

        :root {
            --light: #357987;
            --dark: #035869;
            --fontLight: #ffffff;
            --fontDark: #000000;
            --buttonSize: 160px;
        }

        body {
            padding: 0;
            margin: 0;
            font-family: "Roboto-Light";
            background-color: white;
        }

        .leaflet-container .leaflet-touch .leaflet-fade-anim .leaflet-grab .leaflet-touch-drag .leaflet-touch-zoom {
            background-color: white;
        }

        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            font-weight: normal;
            overflow: hidden;
            font-family: "Roboto-Light";
            background-color: white;
            z-index: 10;
        }

        .leaflet-bar button {
            height: 104px; /* easyButton's height default */
            width: 104px; /*  easyButton's width default */
        }

        /* width */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .leaflet-touch .leaflet-bar a {
            width: 120px!important;
            height: 120px!important;
            line-height: 120px!important;
        }

        .leaflet-touch .leaflet-bar button {
            width: 120px!important;
            height: 120px!important;
            line-height: 120px!important;
        }
        label {
            padding: 1px;
            font-size: 18px;
        }

        .leaflet-control-layers-selector {
            margin-top: 0px !important;
        }

        .leaflet-touch .leaflet-control-layers-toggle {
            background-size: 48px 48px;
            width: var(--buttonSize);
            height: var(--buttonSize);
        }

        .leaflet-control-geosearch a.leaflet-bar-part::before {
            top: 70px !important;
            left: 60px !important;
            width: 30px !important;
            border-top: 4px solid gray !important;
            transform: rotateZ(45deg) !important;
        }

        .leaflet-control-geosearch a.leaflet-bar-part::after {
            top: 30px !important;
            left: 30px !important;
            height: 42px !important;
            width: 42px !important;
            border-radius: 50% !important;
            border: 4px solid gray !important;
        }

        .leaflet-control-geosearch form input {
            background-color: white;
            height: 120px !important;
        }

        .leaflet-control-geosearch form input {
            min-width: 400px;
            width: 100%;
            outline: none;
            border: none;
            margin: 0;
            padding: 0;
            font-family: "Roboto-Light" !important;
            font-size: 24px;
            height: 52px;
            border: none;
            border-radius: 0 4px 4px 0;
            text-indent: 20px !important;
        }

        .results.active {
            margin-left: 30px;
        }

        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out {
            font-size: 44px !important;
        }

        .leaflet-touch .leaflet-bar a {
            color: gray;
            font-family: "Roboto-Light";
        }

        .leaflet-control-zoom-out .leaflet-control-zoom-in {
            color: gray;
            font-family: "Roboto-Light";
        }

        .leaflet-control-layers-expanded {
            color: gray;
            font-family: "Roboto-Light";
        }

        .leaflet-touch:hover .leaflet-bar a:hover {
            color: dimgray;
        }

        .leaflet-control-layers-expanded:hover {
            color: dimgray;
        }

        .leaflet-touch .leaflet-control-geosearch a.reset {
            color: gray;
            font-family: "Roboto-Light";
        }

        .leaflet-touch:hover .leaflet-control-geosearch a.reset:hover {
            color: dimgray;
        }

        .leaflet-control-geosearch form input {
            background-color: white;
            height: 30px;
        }

        .leaflet-popup-content p {
            width: 100%;
            text-align: center;
            margin: 0;
        }

        .leaflet-bar a:last-child {
            border-bottom: none;
        }

        .leaflet-touch .leaflet-bar a:last-child {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: var(--dark);
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: var(--light);
        }

        .leaflet-touch .leaflet-bar button {
            width: 60px;
            height: 60px;
            line-height: 60px;
        }

        .leaflet-touch .leaflet-bar a {
            width: 60px;
            height: 60px;
            line-height: 60px;
        }

        span.button-state.state-get-center.get-center-active {
            margin-left: -3px;
        }

        #metarContainer {
            display: none;
            position: absolute;
            width: 42%;
            height: auto;
            min-height: 25%;
            max-height: 25%;
            left: 100px;
            top: 17%;
            background-color: white;
            z-index: 500;
            border: 2px solid rgba(0, 0, 0, 0.2);
            background-clip: padding-box;
            border-radius: 4px;
        }

        h1#metarTop {
            text-align: center;
            font-size: 2vh;
        }

        table#MetarInputTable {
            display: inline-block;
            position: absolute;
            top: 4vh;
            left: 0;
            right: 0;
            font-size: small;
        }

        p#metarPanel {
            display: inline-block;
            position: absolute;
            top: 9vh;
            bottom: 0;
            left: 0;
            right: 0;
            overflow-y: auto;
            padding-left: 30px;
            padding-right: 30px;
            font-size: 2vh;
        }

        strong {
            padding-left: 10px;
            padding-right: 10px;
            font-size: 2vh;
        }

        input#boton {
            color: black;
            font-family: "Roboto-Light";
            font-weight: normal;
            background-color: #ffffff;
            border: solid #ddd;
            border-width: 2px;
            height: 3.5vh;
            font-size: 2vh;
            margin: 0;
            margin-left: 10px;
        }

        input#aeropuerto {
            font-size: 2vh;
            width: 13vw;
        }

        input#aeropuerto2 {
            font-size: 2vh;
            width: 13vw;
        }

        input#reset {
            color: black;
            font-family: "Roboto-Light";
            font-weight: normal;
            background-color: #ffffff;
            border: solid #ddd;
            border-width: 2px;
            height: 1.6rem;
            font-size: 0.9rem;
            margin: 0;
        }

        #overlay {
            position: absolute;
            width: 25%;
            height: auto;
            min-height: 50%;
            max-height: 50%;
            right: 1vh;
            bottom: 8vh;
            background-color: white;
            z-index: 500;
            border: 2px solid rgba(0, 0, 0, 0.2);
            background-clip: padding-box;
            border-radius: 4px;
        }

        h4#depArrTop {
            position: relative;
            display: inline-table;
            left: 50%;
            -webkit-transform: translate(-50%, 0%);
            transform: translate(-50%, 0%);
        }


        td#start,
        td#target {
            padding-top: 5px;
            font-size: 1.75vh;
        }

        td#dep,
        td#arr {
            padding-top: 20px;
            font-size: 1.5vh;
        }

        #overlayContainer {
            margin-top: -10px;
            font-size: 1.8vh;
            margin-left: 1vh;
        }

        div#overlayListSum {
            position: absolute;
            display: inline-block;
            bottom: 1.5vh;
            left: 0;
            right: 0;
            text-align: center;
            height: 3%;
            font-size: 1.5vh;
        }

        #wpHeaderDiv {
            margin-top: 4vh;
            position: relative;
        }

        h3#wpHeader {
            margin-bottom: 1.5vh;
        }

        #depArrTop {
            margin-top: -30px;
            padding-bottom: 0px;
        }

        table#depArrTable {
            display: inline-table;
            width: 100%;
        }

        ul {
            margin-top: -1vh;
            height: 50px;
            overflow-x: hidden;
            overflow-y: auto;
            text-align: justify;
        }

        #controllerListUl {
            margin-top: 0;
            height: 50px;
            overflow-x: auto;
            overflow-y: auto;
            text-align: justify;
            display: inline;
        }

        h3 {
            margin-top: 2.5vh;
            margin-block-start: 0;
        }

        h4 {
            padding-bottom: 5%;
            margin-block-start: 0;
        }

        #banner {
            position: fixed;
            top: 10px;
            left: 50%;
            -webkit-transform: translate(-50%, 0%);
            transform: translate(-50%, 0%);
            height: auto;
            background-color: transparent;
            z-index: 1000;
            text-align: center;
        }

        #overlay2 {
            display: inline-block;
            max-width: 60%;
            height: 100%;
            background-color: white;
            z-index: 1000;
            border: 2px solid rgba(0, 0, 0, 0.2);
            background-clip: padding-box;
            border-radius: 4px;
            vertical-align: middle;
            display: hidden;
            padding-left: 20px;
            padding-right: 20px;
        }

        table.overlay2Table {
            width: 100%;
            min-height: 90%;
            top: 5%;
            right: 5%;
            bottom: 5%;
            font-size: 2vh;
            text-align: center;
        }

        span#date-time {
            position: absolute;
            top: 1vh;
            font-size: 1.5vh;
            width: 100%;
            text-align: center;
        }

        #overlay ul li {
            padding-top: 10px;
        }

        #overlay ul p {
            padding-bottom: 0;
        }

        #wpListClose {
            position: absolute;
            top: 5px;
            right: 0px;
            color: gray;
            background-color: white;
            border: 0;
            border-radius: 4px;
            font-size: 20px;
        }

        #wpListClose:hover {
            color: lightgray;
        }

        #wpListMinimize {
            position: absolute;
            top: 5px;
            right: 20px;
            color: gray;
            background-color: white;
            border: 0;
            border-radius: 4px;
            font-size: 20px;
        }

        #wpListMinimize:hover {
            color: lightgray;
        }

        p {
            font-family: "Roboto-Light";
            padding: 0;
            margin: 0;
        }

        .resaultLabel {
            padding-bottom: 15px;
        }

        .leaflet-container a.leaflet-popup-close-button {
            position: absolute;
            top: 0px;
            right: 10px;
            padding: 4px 4px 0px 0;
            padding-top: 4px;
            padding-right: 4px;
            padding-bottom: 0px;
            padding-left: 0px;
            border: none;
            text-align: center;
            width: 18px;
            height: 14px;
            font: 20px Tahoma, Verdana, sans-serif;
            font-size: 20px;
            font-family: Tahoma, Verdana, sans-serif;
            color: #c3c3c3;
            text-decoration: none;
            font-weight: bold;
            background: transparent;
            font-size: 20px;
        }

        .leaflet-control-geosearch a.leaflet-bar-part:before {
            top: 19px;
            left: 14px;
            width: 10px;
            border-top: 2px solid gray;
            transform: rotateZ(45deg);
        }

        .leaflet-control-zoom-out {
            border-top-left-radius: 0px;
            border-top-right-radius: 0px;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            background-color: white;
        }

        .leaflet-control-zoom-in {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            border-bottom-left-radius: 0px;
            border-bottom-right-radius: 0px;
            background-color: white;
        }

        .leaflet-control-geosearch a.leaflet-bar-part:after {
            top: 6px;
            left: 6px;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            border: 2px solid gray;
        }

        .leaflet-control-geosearch form {
            display: none;
            position: absolute;
            top: 0;
            left: 30px;
            border-radius: 0 4px 4px 0;
            background-color: #fff;
            /* background-clip: padding-box; */
            z-index: -1;
            height: auto;
            margin: 0;
            padding: 0 8px;
            box-shadow: 0px;
            font-family: "Roboto-Light";
        }

        input .glass {
            font-family: "Roboto-Light";
        }

        .leaflet-popup-content {
            margin: 0;
            line-height: 1.4;
            /* min-width: 200px; */
            display: contents;
        }

        .leaflet-popup-content-wrapper {
            margin: 3px;
            padding: 5px;
            text-align: left;
            border-radius: 4px;
        }

        .leaflet-popup-content p {
            width: 100%;
            text-align: center;
            margin: 0;
        }

        .leaflet-control-scale-line {
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            background-color: #ffffff;
        }

        .leaflet-control-scale-line:not(:first-child) {
            border: 2px solid rgba(0, 0, 0, 0.2);
        }

        .leaflet-popup-close-button {
            color: black;
            font-family: "Roboto-Light";
        }

        .leaflet-geosearch-bar {
            font-family: "Roboto-Light";
        }

        .leaflet-control-geosearch .results>* {
            font-family: "Roboto-Light";
            color: black;
        }

        .leaflet-tooltip.my-labels {
            background-color: transparent;
            border: transparent;
            box-shadow: none;
            font-weight: normal;
            font-size: 14px;
            font-family: "Roboto-Light";
        }

        .leaflet-touch .leaflet-control-layers-toggle {
            background-size: 48px 48px;
            width: var(--buttonSize);
            height: var(--buttonSize);
            transform: scale(1.5);
        }

        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            font-size: 60px !important;
        }

        .leaflet-control-geosearch form {
            display: none;
            position: absolute;
            top: 0;
            left: 110px;
            border-radius: 0 4px 4px 0;
            background-color: #fff;
            /* background-clip: padding-box; */
            z-index: -1;
            height: auto;
            margin: 0;
            padding: 0 8px;
            box-shadow: 0px;
            font-family: "Roboto-Light";
        }

        .leaflet-control-geosearch form input {
            min-width: 400px;
            width: 100%;
            outline: none;
            border: none;
            margin: 0;
            padding: 0;
            font-family: "Roboto-Light" !important;
            font-size: 48px;
            height: 52px;
            border: none;
            border-radius: 0 4px 4px 0;
            text-indent: 20px !important;
            color: gray;
        }

        .leaflet-control-geosearch .results > * {
            line-height: 48px;
            padding: 0 8px;
            border: 1px solid transparent;
            font-family: "Roboto-Light" !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: gray;
        }

        .leaflet-touch .leaflet-control-geosearch a.reset {
            line-height: 48px;
            font-size: 48px;
            padding-right: 20px;
        }

        .leaflet-geosearch-button form {
            max-width: 1200px;
            max-height: 500px;
        }

        .results.active {
            font-size: 35px;
        }


        span.button-state.state-get-center.get-center-active {
            margin-left: -3px;
            font-size: 30px;
            color: gray;
        }

        .quantityTeleport {
            max-width: 5rem;
        }

        .triangle-up {
            width: 0;
            height: 0;
            border-left: 11px solid transparent;
            border-right: 11px solid transparent;
            border-bottom: 21px solid darkblue;
            margin-bottom: 4px;
        }

        .label {
            position: absolute;
            background-color: transparent;
            border: transparent;
            box-shadow: none;
            font-weight: normal;
            font-size: 20px;
            font-family: "Roboto-Light";
            color: darkblue;
            left: -32.5px;
            bottom: -25px;
            width: 100px;
            text-align: center;
            background-color: transparent;
        }

        .labelLabel {
            display: inline-block;
            position: relative;
            background-color: transparent;
            border: transparent;
            box-shadow: none;
            font-weight: normal;
            font-size: 20px;
            font-family: "Roboto-Light";
            color: darkblue;
            text-align: center;
            min-width: 20px;
            text-shadow: -2px 0 white, 0 2px white, 2px 0 white, 0 -2px white;
            border-radius: 5px;
            padding: 0 5px;
        }

        .nameInput {
            border: 2px solid #ddd;
            background-color: #ffffff;
            border-radius: 0;
            text-align: center;
            font-size: 1.3em;
        }

        #controllerOverlay {
            visibility: hidden;
            position: absolute;
            width: 25%;
            height: auto;
            min-height: 50%;
            max-height: 50%;
            left: 10px;
            bottom: 80px;
            background-color: white;
            z-index: 500;
            border: 2px solid rgba(0, 0, 0, 0.2);
            background-clip: padding-box;
            border-radius: 4px;
        }

        #controllerContainer {
            display: inline-block;
            overflow-y: scroll;
            overflow-x: auto !important;
            position: absolute;
            height: auto;
            top: 75px;
            bottom: 5px;
            left: 0;
            right: 0;
        }

        #controllerButton {
            height: var(--buttonSize)!important;
            width: var(--buttonSize)!important;
        }

        #controllerButtonBefore {
            height: var(--buttonSize)!important;
            width: var(--buttonSize)!important;
        }

        #navaidButton {
            height: var(--buttonSize)!important;
            width: var(--buttonSize)!important;
        }

        #navaidButtonBefore {
            height: var(--buttonSize)!important;
            width: var(--buttonSize)!important;
        }

        #controllerListClose {
            position: absolute;
            top: 5px !important;
            right: 10px !important;
            color: gray;
            background-color: transparent;
            border: 0;
            border-radius: 4px;
            font-size: 20px !important;
        }

        #controllerListClose:hover {
            color: lightgray;
        }

        #controllerList {
            text-align: left;
            position: relative;
            left: 20px;
            right: 0;
            top: -20px;
            overflow: auto;
        }

        #controllerList ul p {
            padding-bottom: 5px;
            color: var(--dark);
        }

        #controllerList li {
            padding-bottom: 5px;
            margin-left: 20px;
        }

        h3#controllerHeader {
            padding-top: 15px;
        }

        .atisText {
            word-wrap: break-word;
        }

        a.reset {
            font-size: 20px;
        }

        .leaflet-control-geosearch a.reset {
            line-height: 30px;
            text-align: right;
            padding-right: 10px;
        }

        span.backButton {
            position: absolute;
            width: var(--buttonSize);
            left: -13px;
            bottom: -40px;
            color: gray;
            font-size: 30px;
        }

        span.backButton2 {
            position: absolute;
            width: var(--buttonSize);
            left: -13px;
            bottom: -40px;
            color: gray;
            font-size: 30px;
        }

        i.gg-arrow-down {
            /* text-align: center; */
            position: relative;
            left: 8px;
            top: 10px;
            display: inline-block;
        }

        i.gg-controller {
            /* text-align: center; */
            position: relative;
            left: 0px;
            top: -2px;
            display: inline-block;
        }

        td {
            margin: 0;
            padding: 2px;
            font-size: larger;
            text-align: center;
        }

        input[type="number"] {
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
        }

        .number-input {
            border: 2px solid #ddd;
            display: inline-flex;
            background-color: #ffffff;
        }

        .number-input,
        .number-input * {
            box-sizing: border-box;
            width: 100%;
            width: 100%;
        }

        .number-input button {
            outline: none;
            -webkit-appearance: none;
            background-color: transparent;
            border: none;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            cursor: pointer;
            margin: 0;
            position: relative;
        }

        .number-input button:before,
        .number-input button:after {
            display: inline-block;
            position: absolute;
            content: '';
            width: 0.9rem;
            height: 2px;
            background-color: #212121;
            transform: translate(-50%, -50%);
        }

        .number-input button.plus:after {
            transform: translate(-50%, -50%) rotate(90deg);
        }

        .number-input input[type=text] {
            font-family: "Roboto-Light";
            /* padding: 0.5rem; */
            min-width: 5rem;
            border: solid #ddd;
            border-width: 0 2px;
            font-size: 0.9rem;
            height: 1.5rem;
            font-weight: bold;
            text-align: center;
            background-color: #ffffff;
        }

        .teleportButton {
            color: black;
            width: 100%;
            padding: 0;
            font-family: "Roboto-Light";
            font-weight: normal;
            background-color: #ffffff;
            border: solid #ddd;
            border-width: 2px;
            height: 1.6rem;
            font-size: 0.9rem;
            margin: 0;
        }

        .searchboxTable {
            display: contents;
            width: 100%;
        }

        .marker-delete-button {
            color: black;
            width: 100%;
            margin-top: 3px;
            padding: 0;
            font-family: "Roboto-Light";
            font-weight: normal;
            background-color: #ffffff;
            border: solid #ddd;
            border-width: 2px;
            height: 1.6rem;
            font-size: 0.9rem;
            margin: 0;
        }

        .gg-track {
            color: gray;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs, 3.5));
            width: 10px;
            height: 10px;
            border: 2px solid transparent;
            box-shadow: 0 0 0 2px, inset 0 0 0 10px;
            border-radius: 100px;
            left: 45px;
            top: 55px;
        }

        .gg-track:hover {
            color: dimgray;
        }

        .gg-track::after,
        .gg-track::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            border-radius: 3px
        }

        .gg-track::before {
            border-left: 4px solid;
            border-right: 4px solid;
            width: 18px;
            height: 2px;
            left: -6px;
            top: 2px
        }

        .gg-track::after {
            width: 2px;
            height: 18px;
            border-top: 4px solid;
            border-bottom: 4px solid;
            left: 2px;
            top: -6px
        }

        .gg-track-gray {
            color: lightgrey;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs, 1.7));
            width: 10px;
            height: 10px;
            border: 2px solid transparent;
            box-shadow: 0 0 0 2px, inset 0 0 0 10px;
            border-radius: 100px;
            margin-top: 47%;
            margin-left: 23%;
        }

        .gg-track-gray::after,
        .gg-track-gray::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            border-radius: 3px
        }

        .gg-track-gray::before {
            border-left: 4px solid;
            border-right: 4px solid;
            width: 18px;
            height: 2px;
            left: -6px;
            top: 2px
        }

        .gg-track-gray::after {
            width: 2px;
            height: 18px;
            border-top: 4px solid;
            border-bottom: 4px solid;
            left: 2px;
            top: -6px
        }

        .gg-arrow-down {
            color: gray;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs, 2));
            width: 44px;
            height: 44px;
        }

            .gg-arrow-down::after,
            .gg-arrow-down::before {
                content: "";
                display: block;
                box-sizing: border-box;
                position: absolute;
                bottom: 8px
            }

            .gg-arrow-down::after {
                width: 16px;
                height: 16px;
                border-bottom: 4px solid;
                border-left: 4px solid;
                transform: rotate(-45deg);
                left: 14px
            }

            .gg-arrow-down::before {
                width: 4px;
                height: 32px;
                left: 20px;
                background: currentColor
            }

        #arrowButton {
            height: var(--buttonSize)!important;
            width: var(--buttonSize)!important;
        }

        .gg-controller {
            color: gray;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs, 3));
            width: 8px;
            height: 8px;
            border: 2px solid;
            border-radius: 100px;
            left: 10px;
            top: 5px;
        }

        .gg-controller::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            width: 14px;
            height: 14px;
            box-shadow: -6px -6px 0 -4px, 6px 6px 0 -4px, 6px -6px 0 -4px, -6px 6px 0 -4px;
            left: -5px;
            top: -5px;
            transform: rotate(45deg)
        }

        .gg-erase {
            color: gray;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs, 3));
            width: 22px;
            height: 18px;
            left: -6px;
            top: 3px;
        }

        .gg-erase::after,
        .gg-erase::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute
        }

        .gg-erase::before {
            width: 6px;
            height: 14px;
            border-bottom: 4px solid transparent;
            border-radius: 1px;
            box-shadow: 0 0 0 2px, inset 0 -2px 0 0;
            left: 7px;
            top: 2px;
            transform: rotate(45deg)
        }

        .gg-erase::after {
            background: currentColor;
            width: 22px;
            height: 2px;
            bottom: 0;
            border-radius: 20px
        }

        .gg-edit-markup {
            color: gray;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs, 4));
            width: 22px;
            height: 22px;
            border: 2px solid;
            border-radius: 22px;
            overflow: hidden;
            perspective: 20px;
            left: -6px;
            top: 2px;
        }

        .gg-edit-markup::after,
        .gg-edit-markup::before {
            content: "";
            display: block;
            position: absolute;
            box-sizing: border-box
        }

        .gg-edit-markup::before {
            width: 0;
            height: 6px;
            border-bottom: 6px solid;
            border-left: 3px solid transparent;
            border-right: 3px solid transparent;
            bottom: 9px;
            left: 6px
        }

        .gg-edit-markup::after {
            width: 10px;
            height: 12px;
            border: 2px solid;
            border-top: 4px solid;
            border-bottom: 0;
            bottom: 0;
            left: 4px;
            transform: rotateX(60deg)
        }

        .gg-globe-alt,
        .gg-globe-alt::after,
        .gg-globe-alt::before {
            color: gray;
            display: block;
            box-sizing: border-box;
            height: 18px;
            border: 2px solid;
            color: gray;
            left: 11px;
            top: 18px;
        }

        .gg-globe-alt {
            position: relative;
            transform: scale(var(--ggs, 3));
            width: 18px;
            border-radius: 22px
        }

        .gg-globe-alt::after,
        .gg-globe-alt::before {
            content: "";
            position: absolute;
            width: 8px;
            border-radius: 100%;
            top: -2px;
            left: 3px
        }

        .gg-globe-alt::after {
            width: 24px;
            height: 20px;
            border: 2px solid transparent;
            border-bottom: 2px solid;
            top: -11px;
            left: -5px
        }

        .gg-trash {
            color: gray;
            left: 45px;
            top: 50px;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs, 3));
            width: 10px;
            height: 12px;
            border: 2px solid transparent;
            box-shadow: 0 0 0 2px, inset -2px 0 0, inset 2px 0 0;
            border-bottom-left-radius: 1px;
            border-bottom-right-radius: 1px;
            margin-top: 4px
        }

        .gg-trash::after,
        .gg-trash::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute
        }

        .gg-trash::after {
            background: currentColor;
            border-radius: 3px;
            width: 16px;
            height: 2px;
            top: -4px;
            left: -5px
        }

        .gg-trash::before {
            width: 10px;
            height: 4px;
            border: 2px solid;
            border-bottom: transparent;
            border-top-left-radius: 2px;
            border-top-right-radius: 2px;
            top: -7px;
            left: -2px
        }

        .gg-attribution {
            color: gray;
            position: relative;
            left: -3px;
            top: 3px;
            display: block;
            box-sizing: border-box;
            transform: scale(var(--ggs, 2.5));
            width: 16px;
            height: 18px;
            background: linear-gradient(to left, currentColor 14px, transparent 0) no-repeat 1px 2px/8px 2px, linear-gradient(to left, currentColor 14px, transparent 0) no-repeat 6px 14px/6px 2px, radial-gradient(circle, currentColor 60%, transparent 40%) no-repeat 10px 12px/6px 6px, radial-gradient(circle, currentColor 60%, transparent 40%) no-repeat 0 0/6px 6px;
        }

        .gg-attribution::after,
        .gg-attribution::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            width: 8px;
            height: 8px;
            border: 2px solid;
        }

        .gg-attribution::before {
            border-right: 0;
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
            top: 8px;
            left: 2px
        }

        .gg-attribution::after {
            border-left: 0;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            right: 2px;
            top: 2px
        }

        .gg-pin {
            color: gray;
            left: 40px;
            top: 45px;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: rotate(45deg) scale(var(--ggs, 3));
            width: 18px;
            height: 18px;
            border-radius: 100% 100% 0 100%;
            border: 2px solid;
            margin-top: -4px
        }

        .gg-pin::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            width: 8px;
            height: 8px;
            border: 2px solid;
            top: 3px;
            left: 3px;
            border-radius: 40px
        }

        .gg-repeat {
            color: gray;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs,3));
            box-shadow: -2px -2px 0 0, 2px 2px 0 0;
            width: 14px;
            height: 6px;
            top: 55px;
            left: 42px;
        }

        .gg-repeat::after,
        .gg-repeat::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            width: 0;
            height: 0;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent
        }

        .gg-repeat::before {
            border-left: 5px solid;
            top: -4px;
            right: 0
        }

        .gg-repeat::after {
            border-right: 5px solid;
            bottom: -4px;
            left: 0
        }

        .refreshIcon {
            color: gray;
            display: inline-block;
            width: 40px;
            height: 40px;
            background: url("data:image/svg+xml,%3C%3Fxml version='1.0'%3F%3E%3Csvg fill='gray' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' width='48px' height='48px'%3E%3Cpath d='M 9 3 C 8.448 3 8 3.448 8 4 C 8 4.552 8.448 5 9 5 L 18 5 C 18.552 5 19 5.448 19 6 L 19 15 L 17 15 C 16.596 15 16.231172 15.243188 16.076172 15.617188 C 16.025172 15.741187 16 15.871 16 16 C 16 16.26 16.101969 16.516031 16.292969 16.707031 L 19.292969 19.707031 C 19.683969 20.098031 20.317031 20.098031 20.707031 19.707031 L 23.707031 16.707031 C 23.993031 16.421031 24.077828 15.992188 23.923828 15.617188 C 23.768828 15.243187 23.404 15 23 15 L 21 15 L 21 6 C 21 4.343 19.657 3 18 3 L 9 3 z M 4 4 C 3.744125 4 3.4879687 4.0974687 3.2929688 4.2929688 L 0.29296875 7.2929688 C 0.00696875 7.5789687 -0.077828125 8.0078125 0.076171875 8.3828125 C 0.23117187 8.7568125 0.596 9 1 9 L 3 9 L 3 18 C 3 19.657 4.343 21 6 21 L 15 21 C 15.552 21 16 20.552 16 20 C 16 19.448 15.552 19 15 19 L 6 19 C 5.448 19 5 18.552 5 18 L 5 9 L 7 9 C 7.404 9 7.7688281 8.7568125 7.9238281 8.3828125 C 7.9748281 8.2588125 8 8.129 8 8 C 8 7.74 7.8980312 7.4839687 7.7070312 7.2929688 L 4.7070312 4.2929688 C 4.5115312 4.0974687 4.255875 4 4 4 z'/%3E%3C/svg%3E");
            background-size: 100%;
            position: relative;
            left: -5px;
            top: 2px;
        }

        .gg-stopwatch {
            background: linear-gradient(to left, currentColor 7px,transparent 0) no-repeat 6px 2px/2px 6px;
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs,2.5));
            width: 18px;
            height: 18px;
            border-radius: 100%;
            border: 2px solid transparent;
            box-shadow: 0 0 0 2px
        }

        .gg-stopwatch::after {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            width: 4px;
            height: 2px;
            background: currentColor;
            transform: rotate(45deg);
            right: -4px;
            top: -3px
        }


        .gg-play-pause-o {
            box-sizing: border-box;
            position: relative;
            display: block;
            transform: scale(var(--ggs,2.5));
            width: 22px;
            height: 22px;
            border: 2px solid;
            border-radius: 22px
        }

        .gg-play-pause-o::before {
            content: "";
            display: block;
            box-sizing: border-box;
            position: absolute;
            width: 6px;
            height: 6px;
            left: 6px;
            top: 6px;
            border-left: 2px solid;
            border-right: 2px solid
        }

        .gg-data {
            transform: scale(var(--ggs, 3.5));
            color: gray;
            left: 65px;
            top: 55px
        }

        .gg-data,
        .gg-data::after,
        .gg-data::before {
            box-sizing: border-box;
            position: relative;
            display: block;
            border: 2px solid;
            border-radius: 50%;
            width: 14px;
            height: 14px
        }

        .gg-data::after,
        .gg-data::before {
            content: "";
            position: absolute;
            width: 6px;
            height: 6px;
            top: 2px;
            left: 2px
        }

        .gg-data::after {
            background: linear-gradient(to left, currentColor 8px, transparent 0) no-repeat bottom center/2px 8px;
            width: 22px;
            height: 22px;
            top: -6px;
            left: -6px
        }

        .gg-data,
        .gg-data::after {
            border-top-color: transparent;
            border-bottom-color: transparent
        }


        #keyb {
            visibility: hidden;
            z-index: 2000;
            position: absolute;
            bottom: 0px;
            width: 100%;
            display: inline-block;
        }

        div#keyContainer {
            width: 100%;
        }

        .keyboard {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: auto;
            padding: 0.5vw 0;
            background: var(--dark);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            user-select: none;
            display: inline-flex;
            z-index: 2000;
        }

        .keyboard__keys {
            text-align: center;
        }

        .keyboard__key {
            height: 4vh;
            width: 6vw;
            max-width: 90vw;
            min-height: 10PX;
            min-width: 10px;
            margin: 0.3vw;
            border-radius: 0.4vw;
            border: none;
            background: var(--light);
            color: var(--fontLight);
            font-size: 2.5vw;
            outline: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: top;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .keyboard__key:active {
            background: rgba(255, 255, 255, 0.12);
        }

        .keyboard__key--wide {
            width: 12vw;
        }

        .keyboard__key--spezial {
            width: 30vw;
            max-width: 15vw;
        }

        .keyboard__key--extra-wide {
            width: 36vw;
            max-width: 50vw;
        }

        .keyboard__key--activatable::after {
            content: '';
            top: 20%;
            right: 8%;
            position: absolute;
            width: 0.8vw;
            height: 0.8vw;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            margin: -0.3vw;
        }

        .keyboard--hidden {
            bottom: -100%;
        }

        .keyboard__key--active::after {
            background: #08ff00;
            margin: -0.3vw;
        }

        .keyboard__key--dark {
            background: rgba(0, 0, 0, 0.25);
        }

        .keybord__key--clear {
            background: rgba(255, 0, 0, 0.363);
        }
    </style>
</head>

<body id="documentBody">
    <div id="map">
        <div id="keyb">&nbsp;</div>
    </div>
    <div id="overlay">
        <div>
            <span id='date-time'></span><button id="wpListMinimize" type="button"
                onclick="minimizeWpList()">_</button><button id="wpListClose" type="button" onclick="hideWpList()">
                x
            </button>
        </div>
        <div id="wpHeaderDiv">
            <h3 id="wpHeader" style='font-size: 2.5vh; text-align: center;'>Flightplan</h3>
            <br>
            <h4 id="depArrTop" style='font-size: 15px; text-align: center; ;'>
                <table id="depArrTable">
                    <tr style="font-size: 1.5vh;">
                        <td id="start" style="text-align: center; width: 41%;">Start</td>
                        <td style="text-align: center; width: 18%;" rowspan="2">-</td>
                        <td id="target" style="text-align: center; width: 41%;">Target</td>
                    </tr>
                    <tr style="font-size: 1vh;">
                        <td id="dep" style="text-align: center;">Departure</td>
                        <td id="arr" style="text-align: center;">Arrival</td>
                    </tr>
                </table>
            </h4>
        </div>
        <div id="overlayContainer">
            <div id="overlayList">
                <ul id="content"></ul>
            </div>
        </div>
        <div id="overlayListSum"></div>
    </div>
    <div style="visibility: hidden;" id="controllerOverlay">
        <div>
            <button id="controllerListClose" type="button" onclick="mout()">x</button>
        </div>
        <div id="controllerHeaderDiv" style="margin-top: -20px;">
            <h3 id="controllerHeader" style='font-size: 20px; text-align: center;'>VATSIM Controllers</h3>
        </div>
        <div id="controllerContainer">
            <div id="controllerList">
                <ul id="controllerListUl">
                </ul>
            </div>
        </div>
    </div>
    <div id="metarContainer">
        <span id='date-time'></span><button id="wpListClose" type="button" onclick="hideMetarContainer()">x</button>
        <div id="MetarPanel">

            <h1 id="metarTop">METAR</h1><br>
            <br />
            <form class="contenedor-METAR" method="post">
                <table id="MetarInputTable" cellspacing="8" cellpadding="8">
                    <tr>
                        <td>
                            <input type="text" name="icaoID" id="aeropuerto" class="glass" maxlength="4" size="4"
                                placeholder="START" />
                            <input type="text" name="icaoID2" id="aeropuerto2" class="glass" maxlength="4" size="4"
                                placeholder="DESTINATION" />
                            <input type="button" value="Search" id="boton" onclick="metarSearch();" />
                        </td>
                    </tr>
                </table>
            </form>
            <br />
            <p id="metarPanel" class="contenedor-METAR">
                <br><span id="zona-metar"></span>
                <span id="zona-taf"></span>
                <br><span id="zona-metar2"></span>
                <span id="zona-taf2"></span>
            </p>
        </div>
    </div>
    <div id="banner" style="text-align: center;">
        <div id="overlay2">
            <table class="overlay2Table" style='text-align: center;'>
                <tr>
                    <td>
                        IAS: 9999kts I&nbsp;&nbsp;HEAD:&nbsp;999Â° I&nbsp;&nbsp;DIST:&nbsp;999999nm
                        I&nbsp;&nbsp;ALT:&nbsp;99999ft
                    </td>
                </tr>
            </table>
        </div>
    </div>
</body>

<script>
    var browserDebug = 0;
    var mapState = {
        lat: '',
        lon: '',
        head: '',
        style: ''
    };
    var map;
    var toggle;
    var toggle2;
    var toggle3;
    var toggle4;
    var toggle5;
    var toggle10;
    var toggle11;
    var toggle12;
    var newMarker;
    var airplane;
    var follow;
    var heading = 0;
    var altitude = 0;
    var speed = 0;
    var polyline = [];
    var markers;
    var wp1_lat;
    var wp1_lng;
    var wpi;
    var startLineGroup;
    var pos_lat = 48.6899;
    var pos_lng = 9.22196;
    var coordinates = [];
    var polylinepoints = [];
    var showPath = false;
    var targetMarker = -1;
    var distance;
    var bearing;
    var middleMarkers;
    var headings = [];
    var startlineShow = false;
    var altitudes = [];
    var activeWP;
    var distances = [];
    var deleted = false;
    var wpNum = 0;
    var geosearchLat;
    var geosearchLng;
    var AlgoliaProvider;
    var provider;
    var GeoSearchControl;
    var searchControl;
    var mapCenter = [pos_lat, pos_lng];
    var zoomLevel = 9;
    var airac;
    var LayerControl;
    var wpListOn = false;
    var popupTimeout;
    var waypointmode = true;
    var clickArr = [];
    var markerId = 0;
    var coordinatesArray = [];
    var coordinatesArrayDEP = [];
    var coordinatesArrayARR = [];
    var geojsonFeature;
    var id = 0;
    var markerTimeout;
    var pLineGroup;
    var pLineGroupDEP;
    var pLineGroupARR;
    var pline;
    var plineDEP;
    var plineARR;
    var wpNames = [];
    var wpTypes = [];
    var atbls = [];
    var wpi = 0;
    var wpi2 = 0;
    var wpi3 = 0;
    var dep = "";
    var arr = "";
    var controllersInRange = [];
    var vatsim = true;
    var airportsToggle = 'airports';
    var headerText = "Vatsim Controllers";
    var airports = [];
    var transceivers = [];
    var controllers_array = [];
    var controllersWithCoordArray = [];
    var controllerInterval;
    var stopwatchButton;
    var tempWPName;
    var tempWPType;
    var airportsPanel = false;
    var airports = [];
    var navaids = [];
    var reportingPoints = [];
    var airportMarkers;
    var navaidMarkers;
    var reportingPointMarkers;
    var panelState = '';
    var ActiveMarker;
    var WpBlocked = false;

    window.addEventListener("DOMContentLoaded", function () {
        // Get the message reference
        airac = calculate_airac_cycle();
        var messageElement = document.getElementById('message');
        // Register the event listener
        window.addEventListener('message', receiveMessage);

        if (window.localStorage.getItem("mapCenterLat")) {
            mapCenter[0] = window.localStorage.getItem("mapCenterLat");
            mapCenter[1] = window.localStorage.getItem("mapCenterLng");
        }

        if (window.localStorage.getItem("zoomLevel")) {
            zoomLevel = window.localStorage.getItem("zoomLevel");
        }

        if (window.localStorage.getItem("altitudes")) {
            altitudes = JSON.parse(window.localStorage.getItem("altitudes"));
        }

        if (window.localStorage.getItem("atbls")) {
            atbls = JSON.parse(window.localStorage.getItem("atbls"));
        }

        if (window.localStorage.getItem("wpNames")) {
            wpNames = JSON.parse(window.localStorage.getItem("wpNames"));
        }

        if (window.localStorage.getItem("wpTypes")) {
            wpTypes = JSON.parse(window.localStorage.getItem("wpTypes"));
        }

        if (window.localStorage.getItem("targetMarker")) {
            targetMarker = window.localStorage.getItem("targetMarker");
        }

        loadMap(mapCenter[0], mapCenter[1]);
        var pos = new L.LatLng(pos_lat, pos_lng);
        airplane.setLatLng(pos).update();
        $('#imageAirplane').css('transform', 'rotate(' + Math.round(-45) + 'deg)  scale(0.3)');
        $('#imageAirplane').css('fill', 'red');
        map.panTo(pos);
        Keyboard.init();
        setTimeout(function () { Keyboard.close(); }, 10);

        document.getElementById("getMetar").addEventListener("click", myFunction);

        let ID_Aeropuerto = document.getElementById("aeropuerto");
        ID_Aeropuerto.addEventListener("keypress", function (usuario) {
            if (usuario.keyCode === 13) {
                usuario.preventDefault();
                document.getElementById("boton").click();
            }
        });
    });

    function calculate_airac_cycle() {
        const date = new Date();
        let c_date = new Date(2003, 0, 23);
        let counter = 0;
        let last_count = 0;
        let year = date.getFullYear();

        while (c_date.getTime() < date.getTime()) {
            if (c_date.getFullYear() === date.getFullYear() - 1) {
                last_count++;
            }

            if (c_date.getFullYear() === date.getFullYear()) {
                counter++;
            }

            c_date.setDate(c_date.getDate() + 28);
        };

        if (counter == 0) {
            year -= 1;
            counter = last_count;
        }

        const airac_id = (parseFloat(year.toString().substring(2, 4)) * 100) + counter;
        return airac_id.toString();
    }

    $(function () {
        var height = $('#wpHeaderDiv').outerHeight(true);
        var bottomheight = $('#overlayListSum ').outerHeight(true);
        var overlayheight = $('#overlay ').height();
        $('#content').css('height', overlayheight - height - bottomheight - 20);
    });

    $(window).on('resize', function () {
        var height = $('#wpHeaderDiv').outerHeight(true);
        var bottomheight = $('#overlayListSum ').outerHeight(true);
        var overlayheight = $('#overlay ').height();
        $('#content').css('height', overlayheight - height - bottomheight - 20);
    });

    function getVatsimData() {
        clearInterval(controllerInterval);
        controllers_array = [];
        controllersWithCoordArray = [];
        if (vatsim == true && airportsPanel == false) {
            getControllers();
            getTransceivers();
        }
        else {
            getIVAO();
        }
        listControllers();
    }

    function loadMap(lat, lon) {
        // Create Leaflet map on map element.
        var initMapCenter = mapCenter;
        var initMapZoom = zoomLevel;
        var southWest = new L.LatLng(-90, -180);
        var northEast = new L.LatLng(90, 180);
        var maxExtent = new L.LatLngBounds(southWest, northEast);

        const OPENAIP_API_KEY = '1d96f836f115bc032c90e9335299e6c3';

        var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            bounds: maxExtent,
            maxZoom: 18,
            minZoom: 0,
            format: 'image/png',
            transparent: true,
            reuseTiles: true,
            subdomains: ['a', 'b', 'c']
        });

        var hybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
			attribution: "<a href=\'http://maps.google.com/\'>Google</a> Maps Satellite",
			bounds: maxExtent,
			maxZoom: 20,
			minZoom: 0,
			reuseTiles: true,
			subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
		});

		var satellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
			attribution: "<a href=\'http://maps.google.com/\'>Google</a> Maps Satellite",
			bounds: maxExtent,
			maxZoom: 20,
			minZoom: 0,
			reuseTiles: true,
			subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
		});

        var terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
            bounds: maxExtent,
            maxZoom: 17,
            minZoom: 0,
            format: 'image/png',
            transparent: true,
            reuseTiles: true,
            subdomains: ['a', 'b', 'c']
        });

        var monochrome = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png', {
            attribution: 'Map tiles by <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>.',
            bounds: maxExtent,
            minZoom: 0,
            maxZoom: 14,
            reuseTiles: true
        });

        var water = L.tileLayer('http://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg', {
            attribution: 'Map tiles by <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> .',
            bounds: maxExtent,
            minZoom: 0,
            maxZoom: 14,
            reuseTiles: true
        });

        var airspacesX = L.tileLayer(`https://{s}.api.tiles.openaip.net/api/data/airspaces/{z}/{x}/{y}.png?apiKey=${OPENAIP_API_KEY}`, {
            attribution: '<a href="https://www.openaip.net/">openAIP Data</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-NC-SA</a>)'
            , bounds: maxExtent,
            reuseTiles: true,
            minZoom: 7,
            maxZoom: 12
        });

        var airportsX = L.tileLayer(`https://{s}.api.tiles.openaip.net/api/data/airports/{z}/{x}/{y}.png?apiKey=${OPENAIP_API_KEY}`, {
            attribution: '<a href="https://www.openaip.net/">openAIP Data</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-NC-SA</a>)'
            , bounds: maxExtent,
            reuseTiles: true,
            minZoom: 7,
            maxZoom: 12
        });

        var navaidsX = L.tileLayer(`https://{s}.api.tiles.openaip.net/api/data/navaids/{z}/{x}/{y}.png?apiKey=${OPENAIP_API_KEY}`, {
            attribution: '<a href="https://www.openaip.net/">openAIP Data</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-NC-SA</a>)'
            , bounds: maxExtent,
            reuseTiles: true,
            minZoom: 7,
            maxZoom: 12
        });

        var reporting_pointsX = L.tileLayer(`https://{s}.api.tiles.openaip.net/api/data/reporting-points/{z}/{x}/{y}.png?apiKey=${OPENAIP_API_KEY}`, {
            attribution: '<a href="https://www.openaip.net/">openAIP Data</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-NC-SA</a>)'
            , bounds: maxExtent,
            reuseTiles: true,
            minZoom: 7,
            maxZoom: 12
        });

        var hotspotsX = L.tileLayer(`https://{s}.api.tiles.openaip.net/api/data/hotspots/{z}/{x}/{y}.png?apiKey=${OPENAIP_API_KEY}`, {
            attribution: '<a href="https://www.openaip.net/">openAIP Data</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-NC-SA</a>)'
            , bounds: maxExtent,
            reuseTiles: true,
            minZoom: 7,
            maxZoom: 12
        });

        var airspaces_off = L.tileLayer('http://', {
        });

        var airports_off = L.tileLayer('http://', {
        });

        var navaids_off = L.tileLayer('http://', {
        });

        var hotspots_off = L.tileLayer('http://', {
        });

        var reporting_points_off = L.tileLayer('http://', {
        });

        var aircraft = L.tileLayer('http://', {
        });

        var aircraft_off = L.tileLayer('http://', {
        });

        var flightpath = L.tileLayer('http://', {
        });

        var flightpath_off = L.tileLayer('http://', {
        });

        var flightpath_reset = L.tileLayer('http://', {
        });

        var baseMaps = {
			"Streets": streets,
			"Hybrid": hybrid,
			"Satellite": satellite,
			"Terrain": terrain,
			"Monochrome": monochrome,
			"Water": water
        }

        var groupedOverlays = {
            "Airspaces": {
                'On': airspacesX,
                'Off': airspaces_off
            },
            "Airports": {
                'On': airportsX,
                'Off': airports_off
            },
            "Navaids": {
                'On': navaidsX,
                'Off': navaids_off
            },
            "Hotspots": {
                'On': hotspotsX,
                'Off': hotspots_off
            },
            "Reporting-points": {
                'On': reporting_pointsX,
                'Off': reporting_points_off
            },
            "Aircraft": {
                'On': aircraft,
                'Off': aircraft_off
            },
            "Flightpath": {
                'On': flightpath,
                'Off': flightpath_off,
                'Reset': flightpath_reset
            }
        };

        var options = {
            // Make the "Landmarks" group exclusive (use radio inputs)
            exclusiveGroups: ["Airspaces", "Airports", "Navaids", "Hotspots", "Reporting-points", "Aircraft", "Flightpath"],
            // Show a checkbox next to non-exclusive group labels for toggling all
            groupCheckboxes: true
        };

        var openaip_basemap_osm = L.featureGroup([streets, airspacesX, navaidsX, airportsX, reporting_pointsX, hotspotsX, aircraft, flightpath_off]);

        map = L.map('map', {
            center: mapCenter,
            minZoom: 2,
            zoom: 9,
            edgeBufferTiles: 2,
            layers: [openaip_basemap_osm],
            bounds: maxExtent,
            zoomAnimation: true,
            fadeAnimation: true
        });

        const hash = new L.Hash(map);

        L.control.scale({ maxWidth: 100 }).addTo(map);

        GeoSearchControl = window.GeoSearch.GeoSearchControl;
        AlgoliaProvider = window.GeoSearch.AlgoliaProvider;
        provider = new GeoSearch.OpenStreetMapProvider();

        //  Define search controls
        searchControl = new GeoSearchControl({
            provider: provider,
            autoComplete: true,
            autoCompleteDelay: 250,
            style: 'button',
            id: 'search',
            showMarker: true,
            showPopup: true,
            popupFormat: ({ query, result }) => "<table class='searchboxTable'><tr><td><p style='font-size: 1.5rem'>Teleport<p></td></tr><tr><td class='resaultLabel'>" + result.label + "</td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'><p style='text-align: left'>&nbsp;Altitude (ft): </p></td></tr><tr><td><div class='number-input'><button onclick='altitudeDwn()'></button><input id='altitudeInput' class='quantity' min='0' name='quantity' value= " + Math.round(altitude) + " type='text'><button onclick='altitudeUp()' class='plus'></button></div></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'><p style='text-align: left'>&nbsp;Heading (deg): </p></td><tr><td><div class='number-input'><button onclick='headingDwn()'></button><input id='headingInput' class='quantity' min='0' name='quantity' value= " + Math.round(heading) + " type='text'><button onclick='headingUp()' class='plus'></button></div></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'><p style='text-align: left'>&nbsp;Airspeed (kt): </p></td></tr><tr><td><div class='number-input'><button onclick='speedDwn()'></button><input id='speedInput' class='quantity' min='0' name='quantity' value= " + Math.round(speed) + " type='text'><button onclick='speedUp()' class='plus'></button></div></td></tr><br><tr><td><span style='margin-top: 15px'><button class='teleportButton' type='button' onclick='geoTeleport()'>OK</button></span></td></tr></table></div></div>", // optional: function    - default returns result label,
            autoClose: true,
            keepResult: false,
            retainZoomLevel: true,
            animateZoom: true,
            updateMap: true,
            marker: {
                draggable: true
            }
        });

        // Add searchbar to the map
        map.addControl(searchControl);

        /* Create new layer for markers  */

        map.on('geosearch/showlocation', function (e) {
            disableFollow();
            geosearchLat = e.location.x;
            geosearchLng = e.location.y;
            loadMap(e.location.y, e.location.x)
        });

        function disableFollow() {
            polylinepoints = [];
            polyline = [];
            follow = false;
            toggle.enable();
            if (map.hasLayer(polyline)) {
                map.removeLayer(polyline);
            }
        }

        polyline = L.polyline(polylinepoints);

        map.on('click', function (e) {
            if (waypointmode == false) {
                if (map.hasLayer(newMarker)) {
                    map.removeLayer(newMarker);
                } else {
                    newMarker = new L.marker(e.latlng).addTo(map);
                    newMarker.bindPopup("<table><tr><td><p style='font-size: 1.5rem'>Teleport<p></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'><p style='text-align: left'>&nbsp;Altitude (ft): </p></td></tr><tr><td><div class='number-input'><button onclick='altitudeDwn()'></button><input id='altitudeInput' class='quantityTeleport' min='0' name='quantity' value= " + Math.round(altitude) + " type='text'><button onclick='altitudeUp()' class='plus'></button></div></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'><p style='text-align: left'>&nbsp;Heading (deg): </p></td><tr><td><div class='number-input'><button onclick='headingDwn()'></button><input id='headingInput' class='quantityTeleport' min='0' name='quantity' value= " + Math.round(heading) + " type='text'><button onclick='headingUp()' class='plus'></button></div></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'><p style='text-align: left'>&nbsp;Airspeed (kt): </p></td></tr><tr><td><div class='number-input'><button onclick='speedDwn()'></button><input id='speedInput' class='quantityTeleport' min='0' name='quantity' value= " + Math.round(speed) + " type='text'><button onclick='speedUp()' class='plus'></button></div></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='teleportButton' onclick='teleport(" + e.latlng.lat + "," + e.latlng.lng + ")' >OK</button></span></td></tr></table>").openPopup();
                    var slides = document.getElementsByClassName("leaflet-popup-close-button");
                    for (var i = 0; i < slides.length; i++) {
                        slides[i].innerHTML = '<span>x</font>';
                    }
                }
                follow = false;
                toggle.enable();
            } else {
                if (WpBlocked == false) {
                    var marker;
                    deleted = false;
                    document.getElementById("overlay").style.visibility = 'visible';
                    document.getElementById("overlay2").style.visibility = 'visible';
                    clearTimeout(markerTimeout);
                    //markerTimeout = setTimeout(function(){map.closePopup();}, 6000);
                    //document.getElementById("overlay2").style.display= 'block' ;
                    $(".leaflet-geosearch-bar").css('top', 0);
                    //console.log(geojsonFeature.length);
                    //// hier Ã¤ndern .....
                    geojsonFeature = {
                        "type": "Feature",
                        "properties": {
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [e.latlng.lat, e.latlng.lng]
                        },
                        "id": markerId,
                    }

                    if (markerId == 0) {
                        wp1_lat = e.latlng.lat;
                        wp1_lng = e.latlng.lng;
                    }

                    const svgIcon = L.divIcon({
                        html: `<svg height="30" width="30"><circle cx="15" cy="15" r="5" stroke="grey" stroke-width="3" fill="rgb(41, 129, 202)" /></svg>`,
                        className: "",
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                    });

                    const svgIcon2 = L.divIcon({
                        html: `<svg height="30" width="30"><circle cx="15" cy="15" r="5" stroke="grey" stroke-width="3" fill="rgb(255, 0, 0)" /></svg>`,
                        className: "",
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                    });

                    if (!wpNames[markerId]) {
                        wpNames.push('WP' + (wpi3 + 1));
                        wpTypes.push('User');
                        altitudes.push('0');
                        wpi3++;
                    }

                    getMarkerId();

                    markers = L.layerGroup();
                    markers = L.geoJson(geojsonFeature, {
                        pointToLayer: function (feature, latlng) {
                            marker = L.marker(e.latlng, {
                                title: "WP",
                                alt: 0,
                                name: wpNames[markerId],
                                type: wpTypes[markerId],
                                myId: markerId,
                                coord: e.latlng,
                                riseOnHover: true,
                                draggable: true,
                                icon: svgIcon
                            });
                            return marker;
                        }
                    }).addTo(map);

                    var type = marker.options.type;
                    if (type == 'reportingPoint') {
                        type = 'MRP';
                    }

                    marker.bindTooltip(type + " " + marker.options.name,
                        {
                            permanent: false,
                            direction: 'right'
                        });

                    coordinates.push(e.latlng);

                    const popup = L.popup({
                        autoClose: true,
                        closeOnClick: true
                    });
                    popup.setContent("<table><tr><td><input style= font-size: 1.3rem class='nameInput' onchange='setWPname();' id='WPnameInput' min='0' name='WPnameInput' value = '0' type='text'></input></td></tr><tr><td><p style='font-size: 0.8rem'>" + marker.options.type + "</p></td></tr><tr style='text-align: left;'><td style='text-align: left;'><p style='font-size: 0.8rem, text-align: left;'>" + e.latlng.lat.toFixed(6) + ",<br>" + e.latlng.lng.toFixed(6) + "</p></td></tr><tr><td style='text-align:left; padding:0; font-size: 14px'><p style='text-align: center'>Altitude (ft): </p></td></tr><tr><td><div class='number-input'; onchange='setWPaltitude2();'><button onclick='WPaltitudeDwn()' ondblclick='WPaltitudeDwnDwn()'></button><input id='WPaltitudeInput' class='quantityTeleport' min='0' name='WPaltitudeInput' value=0 type='text'><button onclick='WPaltitudeUp()' ondblclick='WPaltitudeUpUp()' class='plus'></button></div></td></tr><br><tr><td><span style='margin-top: 5px'><button style='margin-top:5px; text-align: center' class='marker-delete-button' onclick='' >Delete</button></span></td></tr><tr><td><span><button style='margin-top:0px; text-align: center' class='teleportButton' onclick='teleport(" + e.latlng.lat + "," + e.latlng.lng + ")' >Teleport</button></span></td></tr></table>");

                    marker.bindPopup(popup);
                    marker.on("popupopen", onPopupOpen);
                    marker.on("click", function (e) {
                        //console.log(this.options.myId);
                        id = this.options.myId;
                        startlineShow = true;
                        showWpList();
                        //console.log(marker.feature.id);
                        const input = document.getElementsByTagName("input")[0];
                        input.focus();
                    });

                    marker.on('mouseover', function (e) {
                        //this.openPopup();
                        id = this.options.myId;
                        showWpList();
                        var tempMarker = this;
                        activeWP = this.options.myId;
                        //setTimeout(loadName, 200);
                        //setTimeout(loadAltitude, 300);

                        $(".marker-delete-button:visible").click(function () {
                            map.removeLayer(tempMarker);
                            pLineGroup.clearLayers();
                            coordinatesArray = [];
                            //console.log(tempMarker);
                            //console.log(tempMarker.feature.geometry.coordinates[0]);
                            $(tempMarker).parent('li').remove();
                            var i = 0;
                            markerId = 0;
                            wpNames.splice(tempMarker.options.myId, 1);
                            wpTypes.splice(tempMarker.options.myId, 1);
                            //console.log(wpNames);
                            $.each(map._layers, function (ml) {
                                if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                                    //map._layers[ml].feature.id = i;
                                    //map._layers[ml].options.myId = i;
                                    coordinates.push(map._layers[ml].feature.geometry.coordinates);
                                    //console.log(map._layers[ml].feature.id);
                                    if (i == 0) {
                                        //console.log(map._layers[ml]);
                                        //console.log(map._layers[ml].feature.geometry.coordinates);
                                        wp1_lat = map._layers[ml].feature.geometry.coordinates[0];
                                        wp1_lng = map._layers[ml].feature.geometry.coordinates[1];
                                    }
                                    i++;
                                    markerId++;
                                }
                            });
                            if (i == 0) {
                                removeAllMarkers();
                            } else {
                                startLineGroup.clearLayers();
                                startlineShow = false;
                            }
                            $('.target').css('color', 'black');
                            localStorage.removeItem('targetMarker');
                            getMarkerId();
                            drawLines();
                        });
                        showWpList();
                        Keyboard.close();
                        clearTimeout(popupTimeout);
                        popupTimeout = setTimeout(function () { map.closePopup(); }, 5000);
                    });

                    marker.on('mouseout', function (e) {
                        //this.closePopup();
                    });
                    var points = getJSON('clickedPoints');
                    follow = false;
                    toggle.enable();
                    //console.log(points);
                    map.closePopup();
                    marker.openPopup();
                    coordinatesArray = [];
                    coordinatesArrayDEP = [];
                    coordinatesArrayARR = [];
                    drawLines();
                    id = markerId;
                    markerId++;
                    if (document.getElementById("keyboard")) {
                        var x = document.getElementById("keyboard");
                        x.style.display = "none";
                    }
                    showWpList();
                    targetMarker = 0;
                    localStorage.setItem('targetMarker', 0);
                }
            }

            marker.on('dragend', function (e) {
                //console.log('Dragend - ID: '+ this.options.myId + ' Coordinate: ' + this.options.coord);
                var dragid = this.options.myId;
                var lat = marker.getLatLng().lat;
                var lng = marker.getLatLng().lng;
                setTimeout(function () {
                    coordinatesArray[dragid][0] = lat;
                    coordinatesArray[dragid][1] = lng;
                    coordinatesArray[dragid][2] = dragid;
                    coordinatesArray = [];
                    coordinatesArrayDEP = [];
                    coordinatesArrayARR = [];
                    drawLines();
                }, 10);

                if (dragid == 0) {
                    wp1_lat = lat;
                    wp1_lng = lng;
                }
                //console.log(coordinatesArray);
                pLineGroup.eachLayer(function (layer) {
                    createMiddleMarkers(layer);
                });
            });
        });

        // Function to handle delete as well as other events on marker popup open
        function onPopupOpen() {
            var tempMarker = this;
            activeWP = this.options.myId;
            setTimeout(loadName, 200);
            setTimeout(loadAltitude, 300);
            // To remove marker on click of delete button in the popup of marker
            $(".marker-delete-button:visible").click(function () {
                map.removeLayer(tempMarker);
                pLineGroup.clearLayers();
                pLineGroupDEP.clearLayers();
                pLineGroupARR.clearLayers();
                coordinatesArray = [];
                coordinatesArrayDEP = [];
                coordinatesArrayARR = [];
                //console.log(tempMarker);
                //console.log(tempMarker.feature.geometry.coordinates[0]);
                $(tempMarker).parent('li').remove();
                wpNames.splice(tempMarker.options.myId, 1);
                wpTypes.splice(tempMarker.options.myId, 1);
                //console.log(wpNames);
                var i = 0;
                markerId = 0;
                $.each(map._layers, function (ml) {
                    if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                        map._layers[ml].feature.id = i;
                        map._layers[ml].options.myId = i;
                        coordinates.push(map._layers[ml].feature.geometry.coordinates);
                        //console.log(map._layers[ml].feature.id);
                        if (i == 0) {
                            //console.log(map._layers[ml]);
                            //console.log(map._layers[ml].feature.geometry.coordinates);
                            wp1_lat = map._layers[ml].feature.geometry.coordinates[0];
                            wp1_lng = map._layers[ml].feature.geometry.coordinates[1];
                        }
                        i++;
                        markerId++;
                    }
                });
                if (i == 0) {
                    removeAllMarkers();
                } else {
                    startLineGroup.clearLayers();
                    startlineShow = false;
                }
                localStorage.removeItem('targetMarker');
                $('.target').css('color', 'black');
                getMarkerId();
                drawLines();
            });

        }

        function loadAltitude() {
            if ($('#WPaltitudeInput')) {
                if (altitudes[activeWP] > 0) {
                    $('#WPaltitudeInput').val(altitudes[activeWP]);
                }
            }
        }

        function loadName() {
            if ($('#WPnameInput')) {
                if (wpNames[activeWP] != '') {
                    $('#WPnameInput').val(wpNames[activeWP]);
                    //console.log('load ' + wpNames[activeWP]);
                }

                $("#WPnameInput").focus(function (e) {
                    id = e.id;
                    //console.log(id + ' focused');
                    textstart = '';
                    textend = '';
                    document.getElementById("keyb").style.visibility = "visible";
                    Keyboard.open(this.value, currentValue => {
                        this.value = currentValue;
                    });
                });

                $("#WPnameInput").click(function (e) {
                    document.getElementById("keyb").style.visibility = "visible";
                    Keyboard.open(this.value, currentValue => {
                        this.value = currentValue;
                    });
                    var text = this.value;
                    textstart = text.slice(0, this.selectionStart);
                    textend = text.slice(this.selectionEnd, this.value.length);
                    Keyboard.properties.value = textstart;
                    getCursorpos();
                });

                $("#WPnameInput").change(function (e) {
                    setWPname();
                });

                $("#WPnameInput").select(function (e) {
                    Keyboard.open(this.value, currentValue => {
                        this.value = currentValue;
                    });
                    var text = this.value;
                    textstart = text.slice(0, this.selectionStart);
                    textend = text.slice(this.selectionEnd, this.value.length);
                    Keyboard.properties.value = textstart;
                });
            }
        }

        pLineGroup = new L.FeatureGroup();
        pLineGroupDEP = new L.FeatureGroup();
        pLineGroupARR = new L.FeatureGroup();
        startLineGroup = new L.FeatureGroup();
        middleMarkers = new L.FeatureGroup();
        pLineGroup.addTo(map);
        pLineGroupDEP.addTo(map);
        pLineGroupARR.addTo(map);

        function drawLines() {
            savePoints();
            wpi = 0;
            wpi2 = 0;
            var poslat = pos_lat;
            var poslng = pos_lng;
            $('#overlayList > ul').empty();
            $('#overlayListSum').empty();
            headings = [];
            if (window.localStorage.getItem("altitudes")) {
                altitudes = JSON.parse(window.localStorage.getItem("altitudes"));
            }
            if (window.localStorage.getItem("distances")) {
                distances = JSON.parse(window.localStorage.getItem("distances"));
            }
            if (window.localStorage.getItem("wpNames")) {
                wpNames = JSON.parse(window.localStorage.getItem("wpNames"));
            }
            if (window.localStorage.getItem("wpTypes")) {
                wpTypes = JSON.parse(window.localStorage.getItem("wpTypes"));
            }

            coordinatesArrayDEP = [];
            coordinatesArrayARR = [];

            $.each(map._layers, function (ml) {
                if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                    //console.log(map._layers[ml]);
                    coordinatesArray.push(map._layers[ml].feature.geometry.coordinates);

                    if (wpi == 0) {
                        if (map._layers[ml].options.type.startsWith("AIRPORT")) {
                            coordinatesArrayDEP.push(map._layers[ml].feature.geometry.coordinates);
                        }
                    }

                    if (map._layers[ml].options.type.startsWith("DEP")) {
                        coordinatesArrayDEP.push(map._layers[ml].feature.geometry.coordinates);
                    }
                    else if (map._layers[ml].options.type.startsWith("ARR")) {
                        coordinatesArrayARR.push(map._layers[ml].feature.geometry.coordinates);
                    }
                    //console.log(map._layers[ml].options.type);
                    wpi++;
                }
            });
            coordinatesArrayARR.push(coordinatesArray[coordinatesArray.length - 1]);


            pline = L.polyline(coordinatesArray, { color: 'rgb(41,129,202)' });
            plineDEP = L.polyline(coordinatesArrayDEP, { color: 'rgb(70,195,51)' });
            plineARR = L.polyline(coordinatesArrayARR, { color: 'rgb(255,198,0)' });


            if (wpi == 0) {
                startLineGroup.clearLayers();
                map.removeLayer(startLineGroup);
            }

            pline = L.polyline(coordinatesArray, { color: 'rgb(41,129,202)' });

            if (map.hasLayer(middleMarkers)) {
                map.removeLayer(middleMarkers);
            }

            if (map.hasLayer(pLineGroup)) {
                pLineGroup.clearLayers();
            }

            if (map.hasLayer(pLineGroupDEP)) {
                pLineGroupDEP.clearLayers();
            }

            if (map.hasLayer(pLineGroupARR)) {
                pLineGroupARR.clearLayers();
            }

            pLineGroup.addLayer(pline);
            pLineGroupDEP.addLayer(plineDEP);
            pLineGroupARR.addLayer(plineARR);

            var startline = setInterval(line, 100);

            if (wpi > 0 && startlineShow == true) {
                if (!map.hasLayer(startLineGroup)) {
                    startLineGroup.addTo(map);
                }
            }
            else {
                if (map.hasLayer(startLineGroup)) {
                    map.removeLayer(startLineGroup);
                }
            }
            pLineGroup.eachLayer(function (layer) {
                createMiddleMarkers(layer);
            });


            $.each(map._layers, function (ml) {
                var altitude = '0';
                if (altitudes[wpi2 - 1]) {
                    altitude = altitudes[wpi2 - 1];
                }
                if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                    //console.log(map._layers[ml].feature);
                    if (wpi2 == 0) {
                        $('#overlayList > ul').append('<li href="#" class="target" id="' + wpi2 + '">' + map._layers[ml].options.name + '<br>' + map._layers[ml].options.type + ' ' + '<a href="#" class="" id="' + wpi2 + ' "></a></li>');
                    }
                    if (wpi2 > 0) {
                        var bearing2 = calculateBearing(coordinatesArray[(wpi2 - 1)][0], coordinatesArray[(wpi2 - 1)][1], coordinatesArray[wpi2][0], coordinatesArray[wpi2][1]);
                        //console.log(bearing2)
                        if (altitudes[wpi2]) {
                            if (Math.round(bearing2) < 10) {
                                if (atbls[wpi2]) {
                                    $('#overlayList > ul').append('<p style="color:var(--light)">00' + Math.round(bearing2) + '&deg; - <a>' + parseFloat(altitude).toFixed(0) + ' ft ' + atbls[wpi2] + '</a></p> ');
                                }
                                else {
                                    $('#overlayList > ul').append('<p style="color:var(--light)">00' + Math.round(bearing2) + '&deg; - <a>' + parseFloat(altitude).toFixed(0) + ' ft ' + '</a></p> ');
                                }
                            }
                            else if (Math.round(bearing2) < 100) {
                                if (atbls[wpi2]) {
                                    $('#overlayList > ul').append('<p style="color:var(--light)">0' + Math.round(bearing2) + '&deg; - <a>' + parseFloat(altitude).toFixed(0) + ' ft ' + atbls[wpi2] + '</a></p> ');
                                }
                                else {
                                    $('#overlayList > ul').append('<p style="color:var(--light)">0' + Math.round(bearing2) + '&deg; - <a>' + parseFloat(altitude).toFixed(0) + ' ft ' + '</a></p> ');
                                }
                            }
                            else {
                                if (atbls[wpi2]) {
                                    $('#overlayList > ul').append('<p style="color:var(--light)">' + Math.round(bearing2) + '&deg; - <a>' + parseFloat(altitude).toFixed(0) + ' ft ' + atbls[wpi2] + '</a></p> ');
                                }
                                else {
                                    $('#overlayList > ul').append('<p style="color:var(--light)">' + Math.round(bearing2) + '&deg; - <a>' + parseFloat(altitude).toFixed(0) + ' ft ' + '</a></p> ');
                                }
                            }
                        }
                        else {
                            if (Math.round(bearing2) < 10) {
                                $('#overlayList > ul').append('<p style="color:var(--light)">00' + Math.round(bearing2) + '&deg;</p> ');
                            }
                            else if (Math.round(bearing2) < 100) {
                                $('#overlayList > ul').append('<p style="color:var(--light)">0' + Math.round(bearing2) + '&deg;</p> ');
                            }
                            else {
                                $('#overlayList > ul').append('<p style="color:var(--light)">' + Math.round(bearing2) + '&deg;</p> ');
                            }
                        }
                        if (distances[wpi2 - 1]) {
                            $('#overlayList > ul').append('<a style="">' + parseFloat(distances[wpi2 - 1]).toFixed(0) + ' nm</a> ');
                        }
                        var type = map._layers[ml].options.type;

                        if (type == 'reportingPoint') {
                            type = 'MRP'
                        }

                        $('#overlayList > ul').append('<li href="#" class="target" id="' + wpi2 + '">' + map._layers[ml].options.name + '<br>' + type + ' ' + '<a href="#" class="" id="' + wpi2 + ' "></a></li>');
                    }
                    wpi2++;
                }
            });

            document.getElementById('start').innerHTML = 'START';
            document.getElementById('target').innerHTML = 'DEST';
            if (wpNames[0]) {
                document.getElementById('start').innerHTML = wpNames[0];
            }
            if (wpNames[wpNames.length - 1] && wpNames.length > 1) {
                document.getElementById('target').innerHTML = wpNames[wpNames.length - 1];
            }
            document.getElementById('depArrTable').style.display = '';
            document.getElementById('dep').innerHTML = 'DEP';
            document.getElementById('arr').innerHTML = 'ARR';

            if (wpTypes[0]) {
                var type = wpTypes[0];
                if (type == 'reportingPoint') {
                    type = 'MRP';
                }
                document.getElementById('dep').innerHTML = type;
            }

            if (wpTypes[1]) {
                var type = wpTypes[wpTypes.length - 1]
                if (type == 'reportingPoint') {
                    type = 'MRP';
                }
                document.getElementById('arr').innerHTML = type;
            }

            if (wpListMinimized == true) {
                document.getElementById("overlay").style.minHeight = '8%';
            }

            for (let i = wpTypes.length - 1; i >= 0; i--) {
                var splitted = wpTypes[i].split(' ');
                var type = splitted[0];
                var name = splitted[1];
                if (type == 'ARR') {
                    document.getElementById('arr').innerHTML = name;
                    break;
                }
            }

            for (let i = 0; i < wpTypes.length; i++) {
                var splitted = wpTypes[i].split(' ');
                var type = splitted[0];
                var name = splitted[1];
                if (type == 'DEP') {
                    document.getElementById('dep').innerHTML = name;
                    break;
                }
            }

            $('.target').on("click", function (event) {
                if (startlineShow == false || targetMarker != event.target.id) {
                    var targetMarker2 = event.target;
                    //console.log('target marker: ' + targetMarker2.id);
                    $(this).css('color', 'red');
                    targetMarker = targetMarker2.id;
                    startlineShow = true;
                    localStorage.setItem('targetMarker', event.target.id);
                    //console.log('target marker saved: ' + event.target.id);
                    secondclick = false;
                    if (!map.hasLayer(startLineGroup)) {
                        map.addLayer(startLineGroup);
                    }
                    $(".leaflet-geosearch-bar").css('top', 72);
                    markerFunction(event.target.id);
                }
                else {
                    $(this).css('color', 'black');
                    if (map.hasLayer(startLineGroup)) {
                        map.removeLayer(startLineGroup);
                    }
                    startlineShow = false;
                    localStorage.setItem('targetMarker', -2);
                    $(".leaflet-geosearch-bar").css('top', -2);
                    targetMarker = -2;
                    localStorage.setItem('targetMarker', -2);
                    if (ActiveMarker != undefined) {
                        map.removeLayer(ActiveMarker);
                    };
                    map.closePopup();
                }
                map.closePopup();
            });
        }

        function markerFunction(id) {
            map.eachLayer(function (layer) {
                if (layer.options.myId == id) {
                    //console.log(layer.options.myId);
                    //layer.openTooltip();
                    //layer.options.icon.options = svgIcon2;
                    const svgIcon = L.divIcon({
                        html: `<svg height="30" width="30"><circle cx="15" cy="15" r="5" stroke="grey" stroke-width="3" fill="rgb(41, 129, 202)" /></svg>`,
                        className: "",
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                    });

                    const svgIcon2 = L.divIcon({
                        html: `<svg height="30" width="30"><circle cx="15" cy="15" r="5" stroke="grey" stroke-width="3" fill="rgb(255, 0, 0)" /></svg>`,
                        className: "",
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                    });

                    console.log(layer.options.coord);
                    if (ActiveMarker != undefined) {
                        map.removeLayer(ActiveMarker);
                    };
                    ActiveMarker = L.marker(layer.options.coord, {
                        title: "Active-WP",
                        alt: 0,
                        name: id,
                        type: id,
                        myId: id,
                        coord: layer.options.coord,
                        riseOnHover: true,
                        draggable: true,
                        icon: svgIcon2
                    }).addTo(map);
                    layer.openTooltip();
                    setTimeout(() => {
                        layer.closeTooltip();
                    }, 2000);

                } else {
                    layer.closeTooltip();
                }
            });
        }

        function line() {
            var nwp1_lat;
            var nwp1_lng;
            var target = localStorage.getItem('targetMarker');
            //console.log(target);
            if (coordinatesArray) {
                var nlat = pos_lat;
                var nlng = pos_lng;
                var i = 0;
                if (coordinatesArray[target]) {
                    if (target <= coordinatesArray.length) {
                        nwp1_lat = coordinatesArray[target][0];
                        nwp1_lng = coordinatesArray[target][1];
                        var p2 = new L.LatLng(nwp1_lat, nwp1_lng);
                        var pos2 = new L.LatLng(nlat, nlng);
                        var coordinates2 = [p2, pos2];
                    }
                    else {
                        startlineShow = false;
                    }

                    if (startlineShow == true) {
                        startLineGroup.clearLayers();
                        startLineGroup.addLayer(L.polyline(coordinates2, { color: '#ff2e63' }));
                    }
                }

                var x = document.querySelectorAll('#overlayList > ul > li');
                for (let i = 0; i < x.length; i++) {
                    x[i].style.color = "";
                    if (i == target && startlineShow == true) {
                        x[i].style.color = "red";
                    }
                }

                var distance2 = 0;
                var planeHeading = 0;
                var alt1 = 0;
                var alt = parseFloat(altitude).toFixed(0);
                var vel = parseFloat(speed).toFixed(0);
                var times = '';

                if (startlineShow == true) {
                    distance2 = calculateDistance(nlat, nlng, nwp1_lat, nwp1_lng, 'nm');
                    planeHeading = calculateBearing(nlat, nlng, nwp1_lat, nwp1_lng);
                }
                if (altitudes[target] && startlineShow == true) {
                    alt1 = parseFloat(altitudes[target]);
                }

                if (distance2 > 0) {
                    times = convertNumToTime(((distance2 / vel) * 60).toFixed(2));
                }

                if (planeHeading != 0 && startlineShow == true) {
                    $('#overlay2').html('<table class="overlay2Table" style="text-align: center;"><tr><td>IAS:&nbsp;' + vel + 'kts  &nbsp;I&nbsp;&nbsp;HEAD:&nbsp;' + heading.toFixed(0) + 'Â° / ' + planeHeading.toFixed(0) + 'Â°  &nbsp;I&nbsp;&nbsp;DIST:&nbsp;' + distance2.toFixed(2) + 'nm&nbsp;/ ' + times + '  I&nbsp;&nbsp;ALT:&nbsp;' + alt + 'ft / ' + alt1.toFixed(0) + 'ft</td></tr></table>');
                }
                else {
                    $('#overlay2').html('<table class="overlay2Table" style="text-align: center;"><tr><td>IAS:&nbsp;' + vel + 'kts  &nbsp;I&nbsp;&nbsp;HEAD:&nbsp;' + heading.toFixed(0) + 'Â°  I&nbsp;&nbsp;ALT:&nbsp;' + alt + 'ft</td></tr></table>');
                }

                distance = calculateDistance(nlat, nlng, nwp1_lat, nwp1_lng, 'K');
                if (distance <= 1) {
                    if (startlineShow == true) {
                        targetMarker++;
                        localStorage.setItem('targetMarker', targetMarker);
                        if (targetMarker == coordinatesArray.length && coordinatesArray.length > 1) {
                            targetMarker = 0;
                            localStorage.setItem('targetMarker', targetMarker);
                            startlineShow = false;
                            if (map.hasLayer(startLineGroup)) {
                                startLineGroup.clearLayers();
                                map.removeLayer(startLineGroup);
                            }
                        }
                    }
                }
            }
        }

        function convertNumToTime(number) {
            // Check sign of given number
            var sign = (number >= 0) ? 1 : -1;
            // Set positive value of number of sign negative
            number = number * sign;
            // Separate the int from the decimal part
            var minutes = Math.floor(number);
            var decpart = number - minutes;
            var min = 1 / 60;
            // Round to nearest secunde
            decpart = min * Math.round(decpart / min);
            var secunde = Math.floor(decpart * 60) + '';
            // Add padding if need
            if (secunde.length < 2) {
                secunde = '0' + secunde;
            }
            var hours = Math.floor(minutes / 60);
            // Add Sign in final result
            sign = sign == 1 ? '' : '-';
            minutes = (minutes - (hours * 60));
            var time = '';
            if (hours > 0 && minutes > 0 && secunde > 0) {
                time = sign + hours + 'hour.&nbsp;' + minutes + 'min.&nbsp;' + secunde + 'sec.';
            }
            else if (hours < 1 && minutes > 0 && secunde > 0) {
                time = sign + minutes + 'min.&nbsp;' + secunde + 'sec.';
            }
            else if (hours < 1 && minutes < 1 && secunde > 0) {
                time = sign + secunde + 'sec.';
            }
            return time;
        }

        // Converts from degrees to radians.
        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        };

        // Converts from radians to degrees.
        function toDegrees(radians) {
            return radians * 180 / Math.PI;
        }

        function calculateBearing(startLat, startLng, destLat, destLng) {
            var start_latitude = toRadians(startLat);
            var start_longitude = toRadians(startLng);
            var stop_latitude = toRadians(destLat);
            var stop_longitude = toRadians(destLng);
            var y = Math.sin(stop_longitude - start_longitude) * Math.cos(stop_latitude);
            var x = Math.cos(start_latitude) * Math.sin(stop_latitude) -
                Math.sin(start_latitude) * Math.cos(stop_latitude) * Math.cos(stop_longitude - start_longitude);
            var brng = Math.atan2(y, x);
            var brng = toDegrees(brng);
            var heading = (brng + 360) % 360;
            headings.push(heading);
            //console.log(headings);
            return heading;
        }

        toggle12 = L.easyButton({
            id: 'getMetar', // an id for the generated button
            class: 'getMetar',
            position: 'topleft', // inherited from L.Control -- the corner it goes in
            type: 'replace', // set to animate when you're comfy with css
            leafletClasses: true, // use leaflet classes to style the button?
            states: [{ // specify different icons and responses for your button
                stateName: 'get-center',
                title: 'METAR',
                icon: '<i id="getMetar"; class="getMetar"></i>' + 'METAR',
            }]
        }).addTo(map);

        toggle = L.easyButton('gg-track', function () {
            follow = true;
            toggle.disable();
            if (map.hasLayer(newMarker)) {
                map.removeLayer(newMarker);
            }
        }).addTo(map);

        zoomLevel = map.getZoom();

        if (window.localStorage.getItem("zoomLevel")) {
            zoomLevel = window.localStorage.getItem("zoomLevel")
            map.setZoom(zoomLevel);
        }

        loadPoints();

        setInterval(function () {
            map.invalidateSize();
            //console.log('invalidate');
        }, 100);


        map.on("dragstart", function (e) {
            toggle.enable();
            follow = false;
        });

        map.on('popupclose', function (e) {
            if (map.hasLayer(newMarker)) {
                map.removeLayer(newMarker);
            }
            if (waypointmode == false) {
                follow = true;
                toggle.disable();
            }
            toggle4.enable();
        });

        map.on('overlayadd', function (e) {
            //console.log(e.group.name);
            if (e.group.name === 'Flightpath') {
                if (e.name === 'On') {
                    //console.log('Flightpath on!');
                    if (map.hasLayer(aircraft)) {
                        if (!map.hasLayer(polyline)) {
                            map.addLayer(polyline);
                            showPath = true;
                        }
                    }
                }
                if (e.name === 'Off') {
                    //console.log('Flightpath off!');
                    if (map.hasLayer(polyline)) {
                        map.removeLayer(polyline);
                        showPath = false;
                    }
                }
                if (e.name === 'Reset') {
                    if (map.hasLayer(aircraft)) {
                        flightpathReset();
                    }
                }
            }
            if (e.group.name === 'Aircraft') {
                if (e.name === 'On') {
                    //console.log('Aircraft on!');
                    var imgAirplane = document.getElementById('imageAirplane');
                    imgAirplane.style.visibility = 'visible';
                    var pos = new L.LatLng(pos_lat, pos_lng);
                    airplane.setLatLng(pos).update();
                    $('#imageAirplane').css('transform', 'rotate(' + Math.round(-45) + 'deg)  scale(0.3)');
                    $('#imageAirplane').css('fill', 'red');

                    if (map.hasLayer(flightpath)) {
                        if (!map.hasLayer(polyline)) {
                            map.addLayer(polyline);
                        }
                    }

                    if (wpi > 0 && startlineShow == true) {
                        if (!map.hasLayer(startLineGroup)) {
                            map.addLayer(startLineGroup);
                        }
                    }

                    if (wpi > 0) {
                        showWpList();
                    }
                }
                if (e.name === 'Off') {
                    //console.log('Aircraft off!');
                    var imgAirplane = document.getElementById('imageAirplane');
                    imgAirplane.style.visibility = 'hidden';

                    if (map.hasLayer(polyline)) {
                        map.removeLayer(polyline);
                    }

                    if (map.hasLayer(startLineGroup)) {
                        map.removeLayer(startLineGroup);
                    }
                    hideWpList();
                }
            }
            if (e.group.name === 'Hotspots') {
                if (e.name === 'On') {
                    //console.log('Hotspots on!');
                    openAIPHotspots = true;
                }

                if (e.name === 'Off') {
                    //console.log('Hotspots off!');
                    openAIPHotspots = false;
                }
            }
        });

        map.on('overlayremove', onOverlayRemove);

        function onOverlayRemove(e) {
        }

        function flightpathReset() {
            if (showPath == true) {
                //console.log('Flightpath reset!');
                if (map.hasLayer(polyline)) {
                    map.removeLayer(polyline);
                    polylinepoints = [];
                    polyline = [];
                    if (showPath == true) {
                        polyline = L.polyline(polylinepoints);
                        map.addLayer(polyline);
                    }
                }
                setTimeout(function () { map.removeLayer(flightpath_reset); map.addLayer(flightpath); }, 100);
            }
            else if (showPath == false) {
                setTimeout(function () { map.removeLayer(flightpath_reset); map.addLayer(flightpath_off); }, 100);
            }
        }

        map.on('zoomend', function () {
            zoomLevel = map.getZoom();
            window.localStorage.setItem("zoomLevel", zoomLevel)
            //console.log("Current Zoom Level = " + zoomLevel);

            if (zoomLevel > 0) {
                toggle11.enable();
                getWPData();
            } else {
                toggle11.disable();
                airportsPanel = false;
                if (panelState == 'airports' || panelState == 'navaids' || panelState == 'reportingPoints') {
                    var controllerOverlay = document.getElementById('controllerOverlay');
                    controllerOverlay.style.visibility = 'hidden';
                    var list = document.getElementById('controllerList');
                    list.style.visibility = 'hidden';
                    panelState = '';
                }

                if (map.hasLayer(navaidMarkers)) {
                    map.removeLayer(navaidMarkers);
                }

                if (map.hasLayer(airportMarkers)) {
                    map.removeLayer(airportMarkers);
                }

            }
        });

        var moveendTimeout;
        map.on('moveend', function (e) {
            map.invalidateSize();
            clearTimeout(moveendTimeout);
            moveendTimeout = setTimeout(function () {
                zoomLevel = map.getZoom();
                if (zoomLevel > 0) {
                    toggle11.enable();
                    getWPData();
                }
            }, 500);
        });

        LayerControl = L.control.groupedLayers(baseMaps, groupedOverlays, options).addTo(map);

        $('.leaflet-control').on('mouseenter', () => {
            if (wpListOn == true) {
                document.getElementById("overlay").style.visibility = 'hidden';
                document.getElementById("overlay2").style.visibility = 'hidden';
                document.getElementById("overlayContainer").style.visibility = 'hidden';
                document.getElementById("banner").style.display = '';

            }
        });

        $('.leaflet-control').on('mouseleave', () => {
            if (wpListOn == true) {
                document.getElementById("overlay").style.visibility = 'visible';
                document.getElementById("overlay2").style.visibility = 'visible';
                document.getElementById("overlayContainer").style.visibility = 'visible';
                document.getElementById("banner").style.display = 'block';
            }
        });

        var firstStart = true;
        $('.glass').on('click', () => {
            if (firstStart == true) {
                firstStart = false;
            }
            Keyboard.open();
        });

        toggle2 = L.easyButton({
            id: 'arrowButton', // an id for the generated button
            position: 'topright', // inherited from L.Control -- the corner it goes in
            type: 'replace', // set to animate when you're comfy with css
            leafletClasses: true, // use leaflet classes to style the button?
            states: [{ // specify different icons and responses for your button
                stateName: 'get-center',
                title: '',
                icon: '<i id="arrow"; class="gg-arrow-down"></i>' + '<span class="backButton">3kts</span><br>',
            }]
        }).addTo(map);

        toggle4 = L.easyButton({
            states: [{
                stateName: 'teleport',
                icon: 'gg-pin',
                title: 'Teleport mode',
                onClick: function (control) {
                    control.state('add-markers');
                    markerId = 0;
                    coordinates = [];
                    coordinatesArray = [];
                    hideWpList();
                    map.closePopup();
                    if (map.hasLayer(startLineGroup)) {
                        map.removeLayer(startLineGroup);
                        startLineGroup.clearLayers();
                    }

                    if (map.hasLayer(pLineGroup)) {
                        map.removeLayer(pLineGroup);
                        pLineGroup.clearLayers();
                    }

                    if (map.hasLayer(pLineGroupDEP)) {
                        map.removeLayer(pLineGroupDEP);
                        pLineGroupDEP.clearLayers();
                    }

                    if (map.hasLayer(pLineGroupARR)) {
                        map.removeLayer(pLineGroupARR);
                        pLineGroupARR.clearLayers();
                    }


                    if (map.hasLayer(middleMarkers)) {

                        map.removeLayer(middleMarkers);
                        middleMarkers.clearLayers();
                    }

                    $.each(map._layers, function (ml) {
                        if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                            map.removeLayer(this);
                        }
                    })
                    window.localStorage.setItem("altitudes", JSON.stringify(altitudes));
                    localStorage.setItem('targetMarker', -1);
                    toggle3 = false;
                    startlineShow = false;
                    waypointmode = false;
                }
            }, {
                icon: 'gg-globe-alt',
                stateName: 'add-markers',
                onClick: function (control) {
                    control.state('teleport');
                    coordinates = [];
                    coordinatesArray = [];
                    altitudes = [];
                    headings = [];
                    map.closePopup();
                    //loadPoints();
                    if (!map.hasLayer(polyline)) {
                        map.addLayer(polyline);
                    }
                    if (!map.hasLayer(pLineGroup)) {
                        map.addLayer(pLineGroup);
                    }
                    if (!map.hasLayer(pLineGroupDEP)) {
                        map.addLayer(pLineGroupDEP);
                    }
                    if (!map.hasLayer(pLineGroupARR)) {
                        map.addLayer(pLineGroupARR);
                    }
                    waypointmode = true;
                    loadPoints();
                },
                title: 'Flightplan mode'
            }]
        });
        toggle4.addTo(map);

        toggle5 = L.easyButton('gg-repeat', function () {
            try {
                //console.log('Get flightplan!');
                var xhr2 = new XMLHttpRequest();
                xhr2.open("POST", 'synchronizeFlightplan', true);
                var myText2 = "foobar";
                xhr2.send(myText2);
                xhr2.onreadystatechange = function () {
                    if (xhr2.readyState == XMLHttpRequest.DONE) {
                        //console.log('Response: ' + xhr2.responseText);
                        if (browserDebug == 0) {
                            window.parent.postMessage('PLN:' + xhr2.responseText, 'coui://html_ui');
                        }
                        else {
                            window.parent.postMessage('PLN:' + xhr2.responseText, '*');
                        }
                    }
                }
            }
            catch (e) {
                //console.log(e);
            }
        }).addTo(map);

        toggle3 = L.easyButton('gg-trash', function () {
            removeAllMarkers();
            var x = document.getElementById("keyboard");
            x.style.display = "none";
        }).addTo(map);

        toggle10 = L.easyButton({
            id: 'controllerButton', // an id for the generated button
            position: 'topright', // inherited from L.Control -- the corner it goes in
            type: 'replace', // set to animate when you're comfy with css
            leafletClasses: true, // use leaflet classes to style the button?
            states: [{
                icon: '<i id="controllerIcon"; class="gg-data"></i>' + '<span class="backButton2">&nbspIVAO</span><br>',
                stateName: 'ivao',
                title: 'IVAO',
                onClick: function (control) {
                    if (document.getElementById('controllerOverlay').style.visibility == 'hidden') {
                        lastIvao = '';
                        lastSelected = -1;
                        lastSelectedElement = null;
                        document.getElementById('controllerListUl').innerHTML = '';
                        vatsim = false;
                        airportsPanel = false;
                        document.getElementById("controllerHeader").innerHTML = "IVAO Controllers";
                        getVatsimData();
                        control.state('ivao');
                        panelState = 'ivao';
                        mover();
                        hideMetarContainer();
                        return
                    }
                    lastVatsim = '';
                    lastSelected = -1;
                    lastSelectedElement = null;
                    document.getElementById('controllerListUl').innerHTML = '';
                    vatsim = true;
                    airportsPanel = false;
                    document.getElementById("controllerHeader").innerHTML = "VATSIM Controllers";
                    getVatsimData();
                    control.state('vatsim');
                    panelState = 'vatsim';
                    hideMetarContainer();
                }
            }, {
                icon: '<i id="controllerIcon"; class="gg-data"></i>' + '<span class="backButton2">&nbspVATSIM</span><br>',
                stateName: 'vatsim',
                title: 'VATSIM',
                onClick: function (control) {
                    if (document.getElementById('controllerOverlay').style.visibility == 'visible') {
                        mout();
                        panelState = '';
                    }
                    lastIvao = '';
                    lastSelected = -1;
                    lastSelectedElement = null;
                    document.getElementById('controllerListUl').innerHTML = '';
                    vatsim = false;
                    airportsPanel = false;
                    document.getElementById("controllerHeader").innerHTML = "IVAO Controllers";
                    getVatsimData();
                    control.state('ivao');
                    panelState = 'ivao';
                    hideMetarContainer();
                }
            }]
        }).addTo(map);

        toggle11 = L.easyButton({
            id: 'navaidButton', // an id for the generated button
            position: 'topright', // inherited from L.Control -- the corner it goes in
            type: 'replace', // set to animate when you're comfy with css
            leafletClasses: true, // use leaflet classes to style the button?
            states: [{
                icon: '<i id="controllerIcon"; class="gg-controller"></i>' + '<span class="backButton2">&nbspAIRPORTS</span><br>',
                stateName: 'airports',
                title: 'AIRPORTS',
                onClick: function (control) {
                    if (document.getElementById('controllerOverlay').style.visibility == 'hidden') {
                        airportsToggle = 'airports';
                        document.getElementById('controllerOverlay').style.visibility = 'visible';
                        document.getElementById('controllerList').style.visibility = 'visible';
                        document.getElementById('controllerListUl').innerHTML = '';
                        document.getElementById("controllerHeader").innerHTML = "Airports";
                        control.state('airports');
                        getWPData();
                        mover();
                        airportsPanel = false;
                        panelState = 'airports';
                        hideMetarContainer();
                        return
                    }
                    airportsToggle = 'navaids';
                    document.getElementById('controllerListUl').innerHTML = '';
                    document.getElementById("controllerHeader").innerHTML = "Navaids";
                    control.state('navaids');
                    getWPData();
                    airportsPanel = true;
                    panelState = 'navaids';
                    hideMetarContainer();
                }
            }, {
                icon: '<i id="controllerIcon"; class="gg-controller"></i>' + '<span class="backButton2">&nbspNAVAIDS</span><br>',
                stateName: 'navaids',
                title: 'NAVAIDS',
                onClick: function (control) {
                    if (document.getElementById('controllerOverlay').style.visibility == 'visible') {
                        mout();
                        panelState = '';
                        return
                    }
                    document.getElementById('controllerListUl').innerHTML = '';
                    airportsToggle = 'airports';
                    airportsPanel = true;
                    document.getElementById("controllerHeader").innerHTML = "Airports";
                    getWPData();
                    control.state('airports');
                    panelState = 'airports';
                    hideMetarContainer();
                }
            }]
        }).addTo(map);

        function clearArray(array) {
            while (array.length) {
                array.pop();
            }
        }

        var iconAirplane = L.divIcon({
            html: '<div id="imageAirplane"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KIDx0aXRsZS8+CgogPGc+CiAgPHRpdGxlPmJhY2tncm91bmQ8L3RpdGxlPgogIDxyZWN0IGZpbGw9Im5vbmUiIGlkPSJjYW52YXNfYmFja2dyb3VuZCIgaGVpZ2h0PSIxMDIiIHdpZHRoPSIxMDIiIHk9Ii0xIiB4PSItMSIvPgogPC9nPgogPGc+CiAgPHRpdGxlPkxheWVyIDE8L3RpdGxlPgogIDxwYXRoIGZpbGw9IiNmZjJlNjMiIHN0cm9rZT0ibnVsbCIgaWQ9InN2Z18xIiBkPSJtOTcuOTg4MDU5LDQuOTU2MzI3YTkuMjA3NDg1LDkuMTIxMDkxIDAgMCAwIC0xNC4wMTU4MDYsLTEuMTcwMzU3bC0xOC4zMzYyNjQsMTguMTY0NTQ5bC00Ny45MjQzNDcsLTEzLjk2MzgyYTQuMTI4NDU3LDQuMDg5NzE5IDAgMCAwIC00LjA4NTQyNywxLjAzMjAwOGwtNS4yODc0MDQsNS4yMzcxNjlhNC4xMzAzMTksNC4wOTE1NjQgMCAwIDAgMC42ODkzNDYsNi4zMzYzODdsMzUuMzE0NTY1LDIyLjQ1MTM5MmwtMy4yMjE0OTUsMy4xOTE1NTVhNjguNjEyOTAxLDY3Ljk2OTEwMiAwIDAgMCAtNy43MzE4NDksOS4xOTEyOTVsLTI0LjQxMjM3NywtMi41Nzk4NGE0LjE1MDIyNSw0LjExMTI4NCAwIDAgMCAtMy4zNzQzNjEsMS4xODE0NzRsLTMuMzgzMzM0LDMuMzUxMDYxYTQuMTQ5ODYzLDQuMTEwOTI0IDAgMCAwIDAuNjkyODI5LDYuMzY2MzM4bDIwLjQzMjY5OCwxMi45ODk1ODFsMTMuMTMyNTI0LDIwLjI3MTI2M2E0LjEyMDIzMyw0LjA4MTU3MiAwIDAgMCA2LjM4MDk5NywwLjY4MTg3MWwzLjQxODkzOCwtMy4zODcwNzRhNC4xMjA4NjIsNC4wODIxOTUgMCAwIDAgMS4xODM0MjYsLTMuMzE5MzYxbC0yLjYwNTAwMiwtMjQuMTk2OTI0YTY4LjU3MTYxMyw2Ny45MjgyMDEgMCAwIDAgOS4yNzc5NjgsLTcuNjU5NTg5bDMuMjIxNDk1LC0zLjE5MTAwNGwyMi42NDE1MzIsMzQuOTQ3NDU3YTQuMTY0NDI0LDQuMTI1MzQ5IDAgMCAwIDYuNDQ5MTU4LDAuNjg5MTA4bDUuMjQyNTYxLC01LjE5MzcwNWE0LjE2NDY2NSw0LjEyNTU4OCAwIDAgMCAxLjA1MDQ0MiwtNC4wODEyNjFsLTE0LjA5MDEzNSwtNDcuNDU0NzgzbDE3Ljk4ODQ3MSwtMTcuODE5OTQ3YzMuMjQxMTExLC0zLjIxMDk4NyA0LjAyOTg2OCwtOC4zODAzNzIgMS4zNTA4NTIsLTEyLjA2NDg0NXoiLz4KIDwvZz4KPC9zdmc+" /></div>',
            iconSize: [100, 100],
            iconAnchor: [50, 50],
            className: 'currentAirplane'
        });

        airplane = L.marker([47.442, 10.23], {
            icon: iconAirplane
        }).addTo(map);
    }

    function hideMetarContainer() {
        document.getElementById("metarContainer").style.display = "none";
        metarSearchExpandet = false;
        Keyboard.close();
    }

    var metarSearchExpandet = false;
    function myFunction() {
        if (metarSearchExpandet == false) {
            document.getElementById("metarContainer").style.display = "inline-Block";
            metarSearchExpandet = true;
            document.getElementById("metarContainer").style.top = getOffset(document.getElementById("getMetar")).top + "px";
            console.log();
            mout();
        }
        else {
            document.getElementById("metarContainer").style.display = "none";
            metarSearchExpandet = false;
        }
    }

    function getOffset(el) {
        const rect = el.getBoundingClientRect();
        return {
            left: rect.left + window.scrollX,
            top: rect.top + window.scrollY
        };
    }

    function METARAbrufen(e) {
        let texto_metar = ' METAR: <br /> ' + e.raw + ' <br /><br />';
        return texto_metar
    }

    function TAFAbrufen(e2) {
        let texto_taf = ' TAF: <br /> ' + e2.raw + ' <br /><br />';
        return texto_taf
    }

    function onERROR(e) {
        reset('ICAO not found!');
        return error = e.error
    }

    const TOKEN_PRIVADO = '8nJJFLHc6Zqz6gu2gSfGZLpJqbzpuv-A0UWPgNZprzk';
    function pedirXML(e, t, start) {
        caja_METAR.innerHTML = "";
        caja_METAR2.innerHTML = "";
        const a = new XMLHttpRequest
        , r = 'https://avwx.rest/api/' + e + '/' + t + '?options=translate,summary&format=json&token=' + TOKEN_PRIVADO;
        a.ontimeout = function () {
            return alert('Server Timed Out.')
        }
        ,
        a.onreadystatechange = function () {
            if (this.readyState === 4) {
                const t = this.response.search('doctype') > 0;
                if (!t && 200 === this.status)
                    return 'metar' === e && (caja_METAR.innerHTML = start + ':<br></br>' + METARAbrufen(JSON.parse(this.response))),
                        'station' === e;
                if (this.status >= 400 && this.status < 500)
                    return onERROR(JSON.parse(this.response));
            }
        }
        ,
        a.open('GET', r, !0),
        a.responseType = 'text',
        a.setRequestHeader('Content-Type', 'text/plain'),
        a.timeout = 1e4,
        a.send()
    }

    function pedirXML2(e, t, destination) {
        caja_METAR.innerHTML = "";
        caja_METAR2.innerHTML = "";
        //console.log('get Metar')
        const a = new XMLHttpRequest
        , r = 'https://avwx.rest/api/' + e + '/' + t + '?options=translate,summary&format=json&token=' + TOKEN_PRIVADO;
        a.ontimeout = function () {
            return alert('Server Timed Out.')
        }
        ,
        a.onreadystatechange = function () {
            if (this.readyState === 4) {
                const t = this.response.search('doctype') > 0;
                if (!t && 200 === this.status)
                    return 'metar' === e && (caja_METAR2.innerHTML = destination + ':<br></br>' + METARAbrufen(JSON.parse(this.response))),
                        'station' === e;
                if (this.status >= 400 && this.status < 500)
                    return onERROR(JSON.parse(this.response));
            }
        }
        ,
        a.open('GET', r, !0),
        a.responseType = 'text',
        a.setRequestHeader('Content-Type', 'text/plain'),
        a.timeout = 1e4,
        a.send()
    }

    function pedirXMLTAF(e, t) {
        //console.log('get Taf')
        const a2 = new XMLHttpRequest
            , r2 = 'https://avwx.rest/api/' + e + '/' + t + '?options=translate,summary&format=json&token=' + TOKEN_PRIVADO;
        a2.ontimeout = function () {
            return alert('Server Timed Out.')
        }
        ,
        a2.onreadystatechange = function () {
            if (this.readyState === 4) {
                const t = this.response.search('doctype') > 0;
                if (!t && 200 === this.status)
                    return 'taf' === e && (caja_Taf.innerHTML = TAFAbrufen(JSON.parse(this.response))),
                        'station' === e;
                if (this.status >= 400 && this.status < 500)
                    return onERROR(JSON.parse(this.response));
            }
        }
        ,
        a2.open('GET', r2, !0),
        a2.responseType = 'text',
        a2.setRequestHeader('Content-Type', 'text/plain'),
        a2.timeout = 1e4,
        a2.send()
    }

    function pedirXMLTAF2(e, t) {
        //console.log('get Taf')
        const a2 = new XMLHttpRequest
            , r2 = 'https://avwx.rest/api/' + e + '/' + t + '?options=translate,summary&format=json&token=' + TOKEN_PRIVADO;
        a2.ontimeout = function () {
            return alert('Server Timed Out.')
        }
        ,
        a2.onreadystatechange = function () {
            if (this.readyState === 4) {
                const t = this.response.search('doctype') > 0;
                if (!t && 200 === this.status)
                    return 'taf' === e && (caja_Taf2.innerHTML = TAFAbrufen(JSON.parse(this.response))),
                        'station' === e;
                if (this.status >= 400 && this.status < 500)
                    return onERROR(JSON.parse(this.response));
            }
        }
        ,
        a2.open('GET', r2, !0),
        a2.responseType = 'text',
        a2.setRequestHeader('Content-Type', 'text/plain'),
        a2.timeout = 1e4,
        a2.send()
    }

    function check_ICAO(e) {
        return !('' === e || 4 != e.length || !e.match('[A-Z]{4}'))
    }

    function reset(e) {
        localStorage.clear();
        caja_METAR.innerHTML = '';
        caja_Taf.innerHTML = '';
        caja_METAR2.innerHTML = '';
        caja_Taf2.innerHTML = '';
    }

    var Timer;
    function metarSearch() {
        var e = document.getElementById('aeropuerto').value;
        var e2 = document.getElementById('aeropuerto2').value;
        e = e.toUpperCase();
        //console.log(e);
        e2 = e2.toUpperCase();
        document.getElementById('aeropuerto').value = e;
        document.getElementById('aeropuerto2').value = e2;
        //console.log(e2);
        const t = e;
        const t2 = e2;
        if (document.getElementById('aeropuerto').value.length == 4) {
            if (!check_ICAO(t)) return; // ICAO Incorrecto
            pedirXML('metar', t, t);
            pedirXMLTAF('taf', t);
            pedirXML('station', t);
        }

        if (document.getElementById('aeropuerto2').value.length == 4) {
            if (!check_ICAO(t2)) return; // ICAO Incorrecto        pedirXML('metar', t);
            pedirXML2('metar', t2, t2);
            pedirXMLTAF2('taf', t2);
            pedirXML2('station', t2);
        }
    }

    let caja_METAR = document.getElementById('zona-metar');
    let caja_Taf = document.getElementById('zona-taf');
    let caja_METAR2 = document.getElementById('zona-metar2');
    let caja_Taf2 = document.getElementById('zona-taf2');
    var lastIvao = "";
    var lastVatsim = "";

    function getControllers() {
        //console.log('Get Controllers!');
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'synchronizeControllers', true);
        var myText = "foobar";
        xhr.send(myText);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                if (xhr.responseText) {
                    if (lastVatsim != xhr.responseText) {
                        var myObj = JSON.parse(xhr.responseText);
                        filterAtis(myObj.atis);
                        filterControllers(myObj.controllers);
                        lastVatsim = xhr.responseText;
                    }
                    listControllers();
                }
            }
        }
    }

    function getTransceivers() {
        //console.log('Get Controllers!');
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'synchronizeTransceivers', true);
        var myText = "foobar";
        xhr.send(myText);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                if (xhr.responseText) {
                    transceivers = JSON.parse(xhr.responseText);
                    listControllers();
                }
            }
        }
    }

    function getIVAO() {
        //console.log('Get Controllers!');
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'synchronizeIVAO', true);
        var myText = "foobar";
        xhr.send(myText);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                if (xhr.responseText) {
                    if (lastIvao != xhr.responseText) {
                        var myObj = JSON.parse(xhr.responseText);
                        //console.log(myObj.clients.atcs);
                        filterIVAO(myObj.clients.atcs);
                        lastIvao = xhr.responseText;
                    }
                    listControllers();
                }
            }
        }
    }

    var innerHTML = '';
    var moverX = false;

    function mover() {
        if (moverX == false) {
            var controllerOverlay = document.getElementById('controllerOverlay');
            controllerOverlay.style.visibility = 'visible';
            controllerOverlay.style.position = 'absolute';
            var list = document.getElementById('controllerList');
            list.style.visibility = 'visible';
            moverX = true;
        }
    }

    function mout() {
        toggle10.state('vatsim');
        toggle11.state('airports');
        panelState = '';
        var controllerOverlay = document.getElementById('controllerOverlay');
        controllerOverlay.style.visibility = 'hidden';
        moverX = false;
        var list = document.getElementById('controllerList');
        list.style.visibility = 'hidden';
    }

    function dynamicSort(property) {
        var sortOrder = 1;
        if (property[0] === "-") {
            sortOrder = -1;
            property = property.substr(1);
        }
        return function (a, b) {
            var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
            return result * sortOrder;
        }
    }

    function dynamicSortMultiple() {
        var props = arguments;
        return function (obj1, obj2) {
            var i = 0, result = 0, numberOfProperties = props.length;
            while (result === 0 && i < numberOfProperties) {
                result = dynamicSort(props[i])(obj1, obj2);
                i++;
            }
            return result;
        }
    }

    function filterAtis(_atis) {
        //console.log(_atis);
        for (var i = 0; i < _atis.length; i++) {
            var controllerCode = _atis[i].callsign.substring(0, _atis[i].callsign.indexOf("_"));
            var callsign = _atis[i].callsign;
            var frequency = _atis[i].frequency;
            var text_atis = [];
            var visualRange = 100;
            if (_atis[i].text_atis) {
                text_atis = _atis[i].text_atis;
            }
            else {
                text_atis = -1;
            }
            var controller = {
                name: controllerCode,
                callsign: callsign,
                frequency: frequency,
                visualRange: visualRange,
                text_atis: text_atis
            }
            controllers_array.push(controller);
        }
    }

    function filterControllers(_controllers) {
        for (var i = 0; i < _controllers.length; i++) {
            var controllerCode = _controllers[i].callsign.substring(0, _controllers[i].callsign.indexOf("_"));
            var callsign = _controllers[i].callsign;
            var frequency = _controllers[i].frequency;
            var visualRange = _controllers[i].visual_range;
            if (_controllers[i].text_atis) {
                var text_atis = _controllers[i].text_atis;
            }
            else {
                var text_atis = -1;
            }
            var controller = {
                name: controllerCode,
                callsign: callsign,
                frequency: frequency,
                visualRange: visualRange,
                text_atis: text_atis
            };
            controllers_array.push(controller);
        };
        getCoordinates(controllers_array);
    }

    function filterIVAO(_ivaoControllers) {
        for (var i = 0; i < _ivaoControllers.length; i++) {
            var controllerCode = _ivaoControllers[i].callsign.substring(0, _ivaoControllers[i].callsign.indexOf("_"));
            var station = _ivaoControllers[i].atcSession.position;
            var callsign = _ivaoControllers[i].callsign;
            var frequency = _ivaoControllers[i].atcSession.frequency;
            var lat = 0;
            var lng = 0;
            if (_ivaoControllers[i].lastTrack) {
                lat = _ivaoControllers[i].lastTrack.latitude;
                lng = _ivaoControllers[i].lastTrack.longitude;
            }
            var visualRange = 100;
            var text_atis = [];
            if (_ivaoControllers[i].atis) {
                text_atis = _ivaoControllers[i].atis.lines;
            }
            else {
                text_atis = -1;
            }
            var controller = {
                name: controllerCode,
                callsign: callsign,
                frequency: frequency,
                visualRange: visualRange,
                text_atis: text_atis,
                lat: lat,
                lng: lng
            };
            if (controller.name != "" && controller.frequency != "") {
                controllersWithCoordArray.push(controller);
            }
        };
        checkInRange(controllersWithCoordArray);
    }

    function getCoordinates(_controllers_array) {
        for (var i = 0; i < _controllers_array.length; i++) {
            //console.log(controllers_array[i].name);
            findAirportCoordinates(_controllers_array[i]);
        };
        checkInRange(controllersWithCoordArray);
    }

    function findAirportCoordinates(_controller) {
        var index = transceivers.findIndex(x => x.callsign === _controller.callsign);
        //console.log(index);
        if (index != -1 && transceivers[index].transceivers[0]) {
            //console.log(transceivers[index].transceivers);
            if (transceivers[index].transceivers.length >= 1) {
                var coordinate = getAreaCenter(transceivers[index].transceivers);
                _controller.lat = coordinate[0];
                _controller.lng = coordinate[1];
                controllersWithCoordArray.push(_controller);
            }
            else {
                _controller.lat = transceivers[index].transceivers[0].latDeg;
                _controller.lng = transceivers[index].transceivers[0].lonDeg;
                controllersWithCoordArray.push(_controller);
            }
        }
    }

    function getAreaCenter(arr) {
        var minX, maxX, minY, maxY;
        for (var i = 0; i < arr.length; i++) {
            minX = (arr[i].latDeg < minX || minX == null) ? arr[i].latDeg : minX;
            maxX = (arr[i].latDeg > maxX || maxX == null) ? arr[i].latDeg : maxX;
            minY = (arr[i].lonDeg < minY || minY == null) ? arr[i].lonDeg : minY;
            maxY = (arr[i].lonDeg > maxY || maxY == null) ? arr[i].lonDeg : maxY;
        }
        return [(minX + maxX) / 2, (minY + maxY) / 2];
    }

    var lastControllers = []

    function checkInRange(_controllersWithCoordArray) {
        //console.log(_controllersWithCoordArray);
        var _CurrentPosLat = lastLat;
        var _CurrentPosLng = lastLng;
        controllersInRange = [];
        for (var i = 0; i < _controllersWithCoordArray.length; i++) {
            var distance = calculateDistance2(parseFloat(pos_lat), parseFloat(pos_lng), _controllersWithCoordArray[i].lat, _controllersWithCoordArray[i].lng);
            var distance = distance.toFixed(0);
            var station = _controllersWithCoordArray[i].callsign.substring(_controllersWithCoordArray[i].callsign.lastIndexOf("_") + 1, _controllersWithCoordArray[i].callsign.length);
            var range = _controllersWithCoordArray[i].visualRange;
            if (station == "CTR" || station == "FSS") {
                if (distance < range) {
                    var controllerInRange = _controllersWithCoordArray[i];
                    controllerInRange.distance = distance;
                    controllersInRange.push(controllerInRange);
                };
            }
            else if (station == "ATIS") {
                if (distance < range) {
                    var controllerInRange = _controllersWithCoordArray[i];
                    controllerInRange.distance = distance;
                    controllersInRange.push(controllerInRange);
                };
            }
            else {
                if (distance < range) {
                    var controllerInRange = _controllersWithCoordArray[i];
                    controllerInRange.distance = distance;
                    controllersInRange.push(controllerInRange);
                };
            }
        }
        controllersInRange.sort(dynamicSortMultiple("distance", "name"));
        if (controllerInRange != lastControllers) {
            document.getElementById('controllerListUl').innerHTML = '';
            listControllers();
            lastControlers = controllersInRange;
        }
        controllerInterval = setInterval(getVatsimData, 10000);
    }

    function getMarkerId() {
        var markerIdArrray = [];
        wpi3 = 0;
        for (let index = 0; index < wpNames.length; index++) {
            const element = wpNames[index];
            if (element) {
                const elementSplit = element.split('WP');
                if (elementSplit[1] && !isNaN(elementSplit[1])) {
                    markerIdArrray.push(elementSplit[1]);
                }
            }
        }
        if (markerIdArrray.length > 0) {
            wpi3 = Math.max.apply(Math, markerIdArrray);
        }
    }

    function removeAllMarkers() {
        WpBlocked = false;
        markerId = 0;
        wpi = 0;
        coordinates = [];
        coordinatesArray = [];
        map.removeLayer(startLineGroup);
        hideWpList();
        if (map.hasLayer(startLineGroup)) {
            map.removeLayer(startLineGroup);
        }
        middleMarkers.clearLayers();
        pLineGroup.clearLayers();
        pLineGroupDEP.clearLayers();
        pLineGroupARR.clearLayers();
        if (map.hasLayer(polyline)) {
            map.removeLayer(polyline);
            polylinepoints = [];
            polyline = [];
            if (showPath == true) {
                polyline = L.polyline(polylinepoints);
                map.addLayer(polyline);
            }
        }
        else {
            if (showPath == true) {
                polyline = L.polyline(polylinepoints);
                map.addLayer(polyline);
            }
        }

        if (map.hasLayer(ActiveMarker)) {
            map.removeLayer(ActiveMarker);
        }
        localStorage.setItem('targetMarker', -1);
        startlineShow = false;
        targetMarker = -1;
        deleteAllMarkers();
        toggle3 = false;
        altitudes = [];
        wpNames = [];
        wpTypes = [];
        wpi2 = 0;
        wpi3 = 0;
        dep = "";
        arr = "";
        map.closePopup();
    }

    function deleteAllMarkers() {
        WpBlocked = false;
        deleted = true;
        $.each(map._layers, function (ml) {
            if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                map.removeLayer(this);
            }
        })
        window.localStorage.removeItem('clickedPoints');
        window.localStorage.removeItem('altitudes');
        //console.log('All markers deleted');
        altitudes = [];
        wpNames = [];
        wpTypes = [];
        atbls = [];
        window.localStorage.removeItem("wpNames");
        window.localStorage.removeItem("wpTypes");
    }


    function setJSON(key, value) {
        window.localStorage.setItem(key, JSON.stringify(value));
    }

    function getJSON(key) {
        return JSON.parse(window.localStorage.getItem(key));
    }

    function loadPoints() {
        var coordinates = getJSON('clickedPoints');
        wpNum = 0;
        if (coordinates) {
            var i = 0;
            coordinates.forEach((entry) => {
                map.fire('click', {
                    latlng: L.latLng(coordinates[i])
                });
                i++;
                wpNum++;
            });
            if (coordinates.length > 2) {
                toggle.enable();
                follow = false;
                var bounds = L.latLngBounds(coordinates);
                map.fitBounds(bounds);
                showWpList();
            }
            else {
                toggle.disable();
                follow = true;
            }
            WpBlocked = true;
            map.closePopup();
        }
        else {
            toggle.disable();
            follow = true;
        }
    }

    function savePoints() {
        var coordinates = [];
        $.each(map._layers, function (ml) {
            if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                //console.log(map._layers[ml].feature);
                coordinates.push(map._layers[ml].feature.geometry.coordinates);
            }
        });
        //console.log(coordinates);
        setJSON('clickedPoints', coordinates);
        window.localStorage.setItem("wpNames", JSON.stringify(wpNames));
        window.localStorage.setItem("wpTypes", JSON.stringify(wpTypes));
        window.localStorage.setItem("altitudes", JSON.stringify(altitudes));
        window.localStorage.setItem("atbls", JSON.stringify(atbls));
    }

    function calcMiddleLatLng(map, latlng1, latlng2) {
        // calculate the middle coordinates between two markers
        const p1 = map.project(latlng1);
        const p2 = map.project(latlng2);
        return map.unproject(p1._add(p2)._divideBy(2));
    }

    function createMiddleMarkers(line) {
        middleMarkers.clearLayers();
        var latlngs = line.getLatLngs();
        distances = [];
        var gesDist = 0;
        for (var i = 1; i < latlngs.length; i++) {
            var left = latlngs[i - 1];
            var right = latlngs[i];
            var newLatLng = calcMiddleLatLng(map, left, right);
            distance = calculateDistance(latlngs[i - 1].lat, latlngs[i - 1].lng, latlngs[i].lat, latlngs[i].lng, 'N');
            distances.push(distance);
            gesDist = gesDist + distance;
            var heading = headings[i - 1];
            if (heading < 10) {
                heading = '00' + Math.round(headings[i - 1]);
            }
            else if (heading < 100) {
                heading = '0' + Math.round(headings[i - 1]);
            }
            else {
                heading = Math.round(headings[i - 1]);
            }
            new L.Marker(newLatLng, {
                icon: new L.DivIcon({
                    className: 'my-div-icon',
                    iconAnchor: [25, 25],
                    iconSize: [50, 50],
                    html: '<div style="background-color:white; color: var(--dark); border-radius: 4px; text-align: center; width:100px; font-size: 16px; border: 2px solid rgba(0,0,0,0.2); background-clip: padding-box;	border-radius: 10px;">' + distance.toFixed(2) + ' nm</div>'
                })
            }).addTo(middleMarkers);

        }
        //middleMarkers.addTo(map);
        $('#overlayListSum').append('<b>Total:</b >&nbsp;' + gesDist.toFixed(2) + ' nm');
    }

    function calculateDistance(lat1, lon1, lat2, lon2, unit) {
        var rlat1 = Math.PI * lat1 / 180;
        var rlat2 = Math.PI * lat2 / 180;
        var rlon1 = Math.PI * lon1 / 180;
        var rlon2 = Math.PI * lon2 / 180;
        var theta = lon1 - lon2;
        var rtheta = Math.PI * theta / 180;
        var distx = Math.sin(rlat1) * Math.sin(rlat2) + Math.cos(rlat1) * Math.cos(rlat2) * Math.cos(rtheta);
        distx = Math.acos(distx);
        distx = distx * 180 / Math.PI;
        distx = distx * 60 * 1.1515;
        if (unit == "K") { distx = distx * 1.609344 };
        if (unit == "N") { distx = distx * 0.8684 };
        return distx;
    }

    function calculateDistance2(lat1, lon1, lat2, lon2) {
        var rlat1 = Math.PI * lat1 / 180;
        var rlat2 = Math.PI * lat2 / 180;
        var rlon1 = Math.PI * lon1 / 180;
        var rlon2 = Math.PI * lon2 / 180;
        var theta = lon1 - lon2;
        var rtheta = Math.PI * theta / 180;
        var dist2 = Math.sin(rlat1) * Math.sin(rlat2) + Math.cos(rlat1) * Math.cos(rlat2) * Math.cos(rtheta);
        dist2 = Math.acos(dist2);
        dist2 = dist2 * 180 / Math.PI;
        dist2 = dist2 * 60 * 1.1515;
        dist2 = dist2 * 0.8684;
        return dist2;
    }

    document.getElementById("overlay").style.visibility = 'hidden';
    document.getElementById("overlay2").style.visibility = 'hidden';
    $(".leaflet-geosearch-bar").css('top', 0);

    var wpListMinimized = false;
    function minimizeWpList() {
        if (wpListMinimized == false) {
            document.getElementById("overlayContainer").style.display = 'none';
            document.getElementById("overlayListSum").style.display = 'none';
            document.getElementById("overlay").style.minHeight = '2%';
            document.getElementById("wpListMinimize").innerHTML = '+';
            wpListMinimized = true;
        }
        else {
            document.getElementById("overlayContainer").style.display = '';
            document.getElementById("overlayListSum").style.display = '';
            document.getElementById("overlay").style.minHeight = '50%';
            document.getElementById("wpListMinimize").innerHTML = '_';
            wpListMinimized = false;
        }
    }

    function hideWpList() {
        wpListOn = false;
        document.getElementById("overlay").style.visibility = 'hidden';
        document.getElementById("overlay2").style.visibility = 'hidden';
        document.getElementById("overlayContainer").style.visibility = 'hidden';
        $(".leaflet-geosearch-bar").css('top', 0);
    }

    function showWpList() {
        if (wpi >= 1) {
            wpListOn = true;
            document.getElementById("overlay").style.visibility = 'visible';
            document.getElementById("overlayContainer").style.visibility = 'visible';
            //$("leaflet-geosearch-bar").css({ top: '100px' });
            $(".leaflet-geosearch-bar").css('top', 72);
            document.getElementById("overlay2").style.visibility = 'visible';
        }
    }

    function altitudeUp() {
        //console.log('altitude Up');
        var altitudeInput = parseFloat(document.getElementById('altitudeInput').value);
        document.getElementById('altitudeInput').value = (altitudeInput + 1);
    }

    function altitudeDwn() {
        //console.log('altitude Down');
        var altitudeInput = parseFloat(document.getElementById('altitudeInput').value);
        document.getElementById('altitudeInput').value = (altitudeInput - 1);
    }

    function headingUp() {
        //console.log('heading Up');
        var headingInput = parseFloat(document.getElementById('headingInput').value);
        document.getElementById('headingInput').value = (headingInput + 1);
    }

    function headingDwn() {
        //console.log('heading Down');
        var headingInput = parseFloat(document.getElementById('headingInput').value);
        document.getElementById('headingInput').value = (headingInput - 1);
    }

    function speedUp() {
        //console.log('speed Up');
        var speedInput = parseFloat(document.getElementById('speedInput').value);
        document.getElementById('speedInput').value = (speedInput + 1);
    }

    function speedDwn() {
        //console.log('speed Down');
        var speedInput = parseFloat(document.getElementById('speedInput').value);
        document.getElementById('speedInput').value = (speedInput - 1);
    }

    function WPaltitudeUp() {
        //console.log('altitude Up');
        var altitudeInput = parseFloat(document.getElementById('WPaltitudeInput').value);
        document.getElementById('WPaltitudeInput').value = (altitudeInput + 100);
        setWPaltitude(altitudeInput + 100);
    }

    function WPaltitudeDwn() {
        //console.log('altitude Down');
        var altitudeInput = parseFloat(document.getElementById('WPaltitudeInput').value);
        document.getElementById('WPaltitudeInput').value = (altitudeInput - 100);
        setWPaltitude(altitudeInput - 100);
    }

    function WPaltitudeUpUp() {
        //console.log('altitude Up');
        var altitudeInput = parseFloat(document.getElementById('WPaltitudeInput').value);
        document.getElementById('WPaltitudeInput').value = (altitudeInput + 1000);
        setWPaltitude(altitudeInput + 1000);
    }

    function WPaltitudeDwnDwn() {
        //console.log('altitude Down');
        var altitudeInput = parseFloat(document.getElementById('WPaltitudeInput').value);
        document.getElementById('WPaltitudeInput').value = (altitudeInput - 1000);
        setWPaltitude(altitudeInput - 1000);
    }

    function setWPaltitude(altitude) {
        //altitudes[activeWP] = parseFloat(alt);
        altitudes[activeWP] = altitude;
        window.localStorage.setItem("altitudes", JSON.stringify(altitudes));
        //altitudes[id] = alt;
        //altitudes.splice(0, 0, parseFloat(document.getElementById('WPaltitudeInput').value));
        updateUlElement();
    }

    function setWPaltitude2() {
        //altitudes[activeWP] = parseFloat(alt);
        altitudes[activeWP] = document.getElementById('WPaltitudeInput').value;
        window.localStorage.setItem("altitudes", JSON.stringify(altitudes));
        //altitudes[id] = alt;
        //altitudes.splice(0, 0, parseFloat(document.getElementById('WPaltitudeInput').value));
        updateUlElement();
    }

    function setWPname() {
        //altitudes[activeWP] = parseFloat(alt);
        if (document.getElementById('WPnameInput')) {
            wpNames[activeWP] = document.getElementById('WPnameInput').value;
        }

        //console.log(wpNames[activeWP]);

        if (document.getElementById('wpNames')) {
            window.localStorage.setItem("wpNames", JSON.stringify(wpNames));
        }
        //altitudes[id] = alt;
        //altitudes.splice(0, 0, parseFloat(document.getElementById('WPaltitudeInput').value));

        if (document.getElementById('WPnameInput')) {
            var WPnameInput = document.getElementById('WPnameInput').value;
            document.getElementById('WPnameInput').value = WPnameInput;
        }

        var wpnum = 0;
        $.each(map._layers, function (ml) {
            if (map._layers[ml].feature && map._layers[ml].feature.mytype != 'airport' && map._layers[ml].feature.mytype != 'navaid' && map._layers[ml].feature.mytype != 'reportingPoint') {
                if (wpnum == (activeWP)) {
                    map._layers[ml].options.name = wpNames[activeWP];
                    map._layers[ml].setTooltipContent(wpNames[activeWP]);
                }
                wpnum++;
            }
        });
        updateLiElement();
    }

    function updateUlElement() {
        var x = document.querySelectorAll('#overlayList > ul > p > a')[activeWP];
        if (x) {
            x.innerHTML = altitudes[activeWP] + ' ft';
        }
    }

    function updateLiElement() {
        var x = document.querySelectorAll('#overlayList > ul > li')[activeWP];
        if (x) {
            x.innerHTML = wpNames[activeWP] + '<br>' + 'User';
        }
    }

    function setPosition(lat, lng) {
        var pos = new L.LatLng(lat, lng);
        airplane.setLatLng(pos).update();
        if (follow == true) {
            map.setView(pos);
            window.localStorage.setItem("mapCenterLat", lat);
            window.localStorage.setItem("mapCenterLng", lng);
        }
        pos_lat = lat;
        pos_lng = lng;
    }

    function setRotation(deg) {
        $('#imageAirplane').css('transform', 'rotate(' + Math.round(deg - 45) + 'deg)  scale(0.3)');
        $('#imageAirplane').css('fill', 'red');
    }

    function setWind(direction, speed) {
        $('i#arrow').css('transform', 'rotate(' + Math.round(direction) + 'deg) scale(2.0)');
        $('.backButton').text(Math.round(direction) + '/' + Math.round(speed));
    }

    function teleport(lat, lng) {
        teleporting = true;
        var x = document.getElementById("keyboard");
        x.style.display = "none";
        if (waypointmode == true) {
            postMessage('map:' + lat + '_' + lng + '_' + altitude + '_' + heading + '_' + speed)
        }
        else {
            var altInput = parseFloat(document.getElementById('altitudeInput').value);
            var headingInput = parseFloat(document.getElementById('headingInput').value);
            var speedInput = parseFloat(document.getElementById('speedInput').value);
            postMessage('map:' + lat + '_' + lng + '_' + parseFloat(altInput) + '_' + parseFloat(headingInput) + '_' + parseFloat(speedInput))
            if (map.hasLayer(newMarker)) {
                map.removeLayer(newMarker);
            }
        }
        teleporting = false;
        map.invalidateSize();
    }

    function geoTeleport() {
        var x = document.getElementById("keyboard");
        x.style.display = "none";
        var altInput = parseFloat(document.getElementById('altitudeInput').value);
        var headingInput = parseFloat(document.getElementById('headingInput').value);
        var speedInput = parseFloat(document.getElementById('speedInput').value);
        postMessage('map:' + geosearchLng + '_' + geosearchLat + '_' + Math.round(altInput) + '_' + Math.round(headingInput) + '_' + Math.round(speedInput));
        pLineGroup.clearLayers();
        pLineGroupDEP.clearLayers();
        pLineGroupARR.clearLayers();
        if (map.hasLayer(polyline)) {
            map.removeLayer(polyline);
        }
        polylinepoints = [];
        polyline = [];
        if (showPath == true) {
            polyline = L.polyline(polylinepoints);
            map.addLayer(polyline);
        }
    }

    var lastLat;
    var lastLng;
    var flightplan;
    var atbl = [];
    lastLat = '13.493889';
    lastLng = '52.351389';
    var tunedFrequency = '';
    let readyToPost = false;
    // Receive controls from parent page
    function receiveMessage(e) {
        var sender = e.data.substr(0, e.data.indexOf(':'));
        var message = e.data.substr(e.data.indexOf(':') + 1, e.data.length);
        //console.log(e.data);
        if (sender == 'Position') {
            if (browserDebug == 0) {
                // Call function:
                var latlng = message.split("_");
                altitude = (latlng[2]);
                heading = latlng[3] * 180 / Math.PI;
                speed = (latlng[4]);
                $('#map').css('height', latlng[7] - 10 + 'px');
                $('body').css('height', latlng[7] - 10 + 'px');
                $('html').css('height', latlng[7] - 10 + 'px');
                document.documentElement.style.setProperty('--light', latlng[8]);
                document.documentElement.style.setProperty('--dark', latlng[9]);
                document.documentElement.style.setProperty('--fontLight', latlng[10]);
                document.documentElement.style.setProperty('--fontDark', latlng[11]);
                var dt = new Date();
                var time = addZeroBefore(dt.getUTCHours()) + ":" + addZeroBefore(dt.getUTCMinutes());
                var date = dt.getFullYear().toString().substr(-2) + '-' + addZeroBefore(dt.getMonth() + 1) + '-' + addZeroBefore(dt.getDate());
                document.getElementById('date-time').innerHTML = date + " " + time + "z";
                setPosition(latlng[0], latlng[1]);
                setRotation(heading);
                setWind(latlng[5], latlng[6]);
                if (latlng[0] != lastLat && latlng[1] != lastLng) {
                    if (showPath == true) {
                        setTimeout(polyline.addLatLng([lastLat, lastLng]), 1000);
                    }
                    lastLat = latlng[0];
                    lastLng = latlng[1];
                }
            }
        }
        else if (sender == 'Flightplan') {
            //console.log(message);
            flightplan = JSON.parse(message);
            if (flightplan) {
                var x = document.getElementById("keyboard");
                x.style.display = "none";
                removeAllMarkers();
                setTimeout(setWaypoints, 1000);
            }
        }
    }

    function addZeroBefore(n) {
        return (n < 10 ? '0' : '') + n;
    }

    //This function takes in latitude and longitude of two location and returns the distance between them as the crow flies (in km)
    function calcCrow(lat1, lon1, lat2, lon2) {
        var R = 6371; // km
        var dLat = toRad(lat2 - lat1);
        var dLon = toRad(lon2 - lon1);
        var lat1 = toRad(lat1);
        var lat2 = toRad(lat2);

        var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c;
        return d;
    }

    // Converts numeric degrees to radians
    function toRad(Value) {
        return Value * Math.PI / 180;
    }

    function setWaypoints() {
        var i = 0;
        var i2 = 0;
        wpi = 0;

        altitudes = [];
        atbls = [];
        wpTypes = [];
        wpNames = [];
        flightplan.forEach((entry) => {
            if (entry.altitude) {
                altitudes.splice(i2, 0, String(parseFloat(entry.altitude).toFixed(0)));
            }
            else {
                altitudes.splice(i2, 0, "0");
            }

            if (entry.atbl) {
                if (entry.atbl == "AT_OR_ABOVE") {
                    atbls.splice(i2, 0, 'A');
                }
                if (entry.atbl == "AT_OR_BELOW") {
                    atbls.splice(i2, 0, 'B');
                }
                else {
                    atbls.splice(i2, 0, '');
                }
            }

            if (entry.name) {
                if (entry.name == 'TIMEDSCNT') {
                    wpNames.splice(i2, 0, 'TOD');
                    wpTypes.push('Info');

                }
                else if (entry.name == 'TIMECRUIS') {
                    wpNames.splice(i2, 0, 'TOC');
                    wpTypes.push('Info');

                } else {
                    wpNames.splice(i2, 0, entry.name);
                    if (entry.waypointType) {
                        wpTypes.push(entry.waypointType);
                    }
                    else {
                        wpTypes.push('User');
                    }
                }
            }
            else {
                wpNames.splice(i2, 0, "WP" + (wpi3 + 1));
                wpi3++;
            }
            i2++;
        });

        window.localStorage.setItem("wpNames", JSON.stringify(wpNames));
        window.localStorage.setItem("wpTypes", JSON.stringify(wpTypes));
        window.localStorage.setItem("altitudes", JSON.stringify(altitudes));
        window.localStorage.setItem("atbls", JSON.stringify(atbls));

        flightplan.forEach((entry) => {
            map.fire('click', {
                latlng: L.latLng([flightplan[i].lat, flightplan[i].lng])
            });
            i++;
        });

        if (flightplan.length > 2) {
            toggle.enable();
            follow = false;
            var bounds = L.latLngBounds(coordinates);
            map.fitBounds(bounds);
            showWpList();
        }
        else {
            toggle.disable();
            follow = true;
        }
        map.closePopup();
        getMarkerId();
        WpBlocked = true;
    }

    // Send postMessage
    function postMessage(message) {
        toggle.disable();
        if (browserDebug == 0) {
            // Get the iFrame and the button reference
            window.parent.postMessage(message, 'coui://html_ui');
            //console.log('Postmessage send: ' + message);
        }
        else {
            window.parent.postMessage(message, '*');
        }
    }

    var cursorPos = null;
    function getCursorpos() {
        cursorPos = document.getElementsByTagName("input")[0].selectionStart;
    }

    function setCursorpos() {
        if (cursorPos != null) {
            var targetTextarea = document.getElementsByTagName("input")[0];
            targetTextarea.focus();
            setCaretToPos(targetTextarea, cursorPos);
            var text = targetTextarea.value;
            Keyboard.properties.value = targetTextarea.value;
            textstart = text.slice(0, targetTextarea.selectionStart);
            textend = text.slice(targetTextarea.selectionStart, targetTextarea.value.length);
        }
    }

    function setSelectionRange(input, selectionStart, selectionEnd) {
        if (input.setSelectionRange) {
            input.focus();
            input.setSelectionRange(selectionStart, selectionEnd);
        }
        else if (input.createTextRange) {
            var range = input.createTextRange();
            range.collapse(true);
            range.moveEnd('character', selectionEnd);
            range.moveStart('character', selectionStart);
            range.select();
        }
    }

    function setCaretToPos(input, pos) {
        setSelectionRange(input, pos, pos);
    }

    var selected = false;
    var lastSelected = -1;
    var lastSelectedElement;
    function listControllers() {
        $('#controllerList > ul').empty();
        var list = document.getElementById('controllerList');
        list.style.display = 'inline-block';
        var ctr = controllersInRange.filter(x => x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'CTR' || x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'FSS');
        var app = controllersInRange.filter(x => x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'APP' || x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'DEP');
        var twr = controllersInRange.filter(x => x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'TWR');
        var gnd = controllersInRange.filter(x => x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'GND');
        var del = controllersInRange.filter(x => x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'DEL');
        var atis = controllersInRange.filter(x => x.callsign.substring(x.callsign.lastIndexOf("_") + 1, x.callsign.length) === 'ATIS');

        $('#controllerList > ul').append('<p>Center</p>');
        for (var i = 0; i < ctr.length; i++) {
            $('#controllerList > ul').append('<li href="#" class="station" id=' + ctr[i].callsign + '>' + ctr[i].callsign + ' -&nbsp' + ctr[i].frequency + '</li>');
        }
        $('#controllerList > ul').append('<p>App./Dep.</p>');
        for (var i = 0; i < app.length; i++) {
            $('#controllerList > ul').append('<li href="#" class="station" id=' + app[i].callsign + '>' + app[i].callsign + ' -&nbsp' + app[i].frequency + '</li>');
        }
        $('#controllerList > ul').append('<p>Tower</p>');
        for (var i = 0; i < twr.length; i++) {
            $('#controllerList > ul').append('<li href="#" class="station" id=' + twr[i].callsign + '>' + twr[i].callsign + ' -&nbsp' + twr[i].frequency + '</li>');
        }
        $('#controllerList > ul').append('<p>Ground</p>');
        for (var i = 0; i < gnd.length; i++) {
            $('#controllerList > ul').append('<li href="#" class="station" id=' + gnd[i].callsign + '>' + gnd[i].callsign + ' -&nbsp' + gnd[i].frequency + '</li>');
        }
        $('#controllerList > ul').append('<p>Delivery</p>');
        for (var i = 0; i < del.length; i++) {
            $('#controllerList > ul').append('<li href="#" class="station" id=' + del[i].callsign + '>' + del[i].callsign + ' -&nbsp' + del[i].frequency + '</li>');
        }
        if (vatsim == true) {
            $('#controllerList > ul').append('<p>ATIS</p>');
            for (var i = 0; i < atis.length; i++) {
                $('#controllerList > ul').append('<li href="#" class="station" id=' + atis[i].callsign + '>' + atis[i].callsign + ' -&nbsp' + atis[i].frequency + '</li>');
            }
        }
        $('#controllerList > ul').append('<p>UNICOM</p>');
        $('#controllerList > ul').append('<li href="#" class="station" id="UNICOM">UNICOM - 122.800</li>');

        //console.log(controllersInRange);
        var stations = document.getElementsByClassName("station");
        var frequency = "";
        for (var i = 0; i < stations.length; i++) {
            stations[i].addEventListener('mousedown', function (e) { e.preventDefault(); }, false);
            stations[i].addEventListener("click", function (e) {
                for (var i = 0; i < stations.length; i++) {
                    stations[i].style.color = 'black';
                };
                //console.log(this.id);
                var index = controllersInRange.findIndex(x2 => x2.callsign === this.id);
                if (lastSelected != this.id && this.id != 'UNICOM') {
                    if (lastSelected != -1) {
                        var index2 = controllersInRange.findIndex(x3 => x3.callsign === lastSelected);
                        lastSelectedElement.innerHTML = controllersInRange[index2].callsign + ' -&nbsp' + controllersInRange[index2].frequency;;
                    };
                    selected = true;
                    lastSelected = this.id;
                    lastSelectedElement = this;
                    //this.style.color = 'black';
                    //console.log(controllersInRange[index]);
                    if (index != -1) {
                        if (controllersInRange[index].text_atis != -1) {
                            var atisString = '';
                            controllersInRange[index].text_atis.forEach(element => {
                                if (element != "") {
                                    atisString += element + '<br>';
                                }
                            });
                            var innerText = controllersInRange[index].callsign + ' -&nbsp' + controllersInRange[index].frequency + '<br><p class="atisText"><i>' + atisString + '</i></p>';
                            this.innerHTML = innerText;
                        }
                        //console.log('Frequency: ' + controllersInRange[index].frequency);
                    };
                    if (this.id == "UNICOM") {
                        //console.log('Frequency: 122.800');
                    }
                    clearInterval(controllerInterval);
                }
                else if (this.id != 'UNICOM') {
                    //this.style.color = 'black';
                    var innerText = controllersInRange[index].callsign + ' -&nbsp' + controllersInRange[index].frequency;
                    this.innerHTML = innerText;
                    selected = false;
                    lastSelected = -1;
                    controllerInterval = setInterval(getVatsimData, 10000);
                }
            });
        };
    }

    function selectController(id) {
        var target = document.getElementById(id);
    }

    function tuneController(id) {
        var target = document.getElementById(id);
    }

    function deselectController(id) {
        var target = document.getElementById(id);
        target.style.color = 'black';
        var innerText = controllersInRange[index].callsign + ' -&nbsp' + controllersInRange[index].frequency;
        target.innerHTML = innerText;
        selected = false;
        lastSelected = -1;
    }
    var navaidsCounter = 10;
    var airportsCounter = 10;
    var reportingPointsCounter = 10;

    function moreAirports() {
        //console.log('more Airports');
        airportsCounter = airportsCounter + 10;
        listNavaids();
    }

    function moreNavaids() {
        //console.log('more Navaids');
        navaidsCounter = navaidsCounter + 10;
        listNavaids();
    }

    function moreReportingPoints() {
        //console.log('more Navaids');
        reportingPointsCounter = reportingPointsCounter + 10;
        listNavaids();
    }

    function listNavaids() {
        var list = document.getElementById('controllerList');
        list.style.display = 'inline-block';
        $('#controllerList > ul').empty();
        if (airportsToggle == 'airports') {
            navaidsCounter = 10;
            var airportsI = 0;
            var type = '';
            airports.forEach(element => {
                if (airportsI < airportsCounter && element.properties.type) {
                    switch (element.properties.type) {
                        case 0:
                            type = "Airport (civil/military)";
                            break;
                        case 1:
                            type = "Glider Site";
                            break;
                        case 2:
                            type = "Airfield Civil";
                            break;
                        case 3:
                            type = "International Airport";
                            break;
                        case 4:
                            type = "Heliport Military";
                            break;
                        case 5:
                            type = "Military Aerodrome";
                            break;
                        case 6:
                            type = "Ultra Light Flying Site";
                            break;
                        case 7:
                            type = "Heliport Civil";
                            break;
                        case 8:
                            type = "Aerodrome Closed";
                            break;
                        case 9:
                            type = "Airport resp. Airfield IFR";
                            break;
                        case 10:
                            type = "Airfield Water";
                            break;
                        case 11:
                            type = "Landing Strip";
                            break;
                        case 12:
                            type = "Agricultural Landing Strip";
                            break;
                        case 13:
                            type = "Altiport";
                    }
                    //console.log(element);
                    if (element.properties.icaoCode) {
                        $('#controllerList > ul').append('<li href="#" class="station2" id="' + element.properties.name + '">' + element.properties.icaoCode + ' - ' + type + '</li>');
                    } else {
                        $('#controllerList > ul').append('<li href="#" class="station2" id="' + element.properties.name + '">' + element.properties.name + ' - ' + type + '</li>');
                    }
                    airportsI++;
                }
            });
            if (airports.length > 10) {
                $('#controllerList > ul').append('<span href="#" class="station2" onclick="moreAirports()" id="counter">' + "show&nbsp;more..." + '</span>');
            }
        }
        else if (airportsToggle == 'navaids') {
            var navaidsI = 0;
            airportsCounter = 10;
            //console.log(navaids);
            //$('#controllerList > ul').append('<p>Test</p>');
            navaids.forEach(element2 => {
                if (navaidsI < navaidsCounter && element2.properties.type) {
                    //console.log(element2.properties.identifier);
                    var type = '';
                    switch (element2.properties.type) {
                        case 0:
                            type = "DME";
                            break;
                        case 1:
                            type = "TACAN";
                            break;
                        case 2:
                            type = "NDB";
                            break;
                        case 3:
                            type = "VOR";
                            break;
                        case 4:
                            type = "VOR-DME";
                            break;
                        case 5:
                            type = "VORTAC";
                            break;
                        case 6:
                            type = "DVOR";
                            break;
                        case 7:
                            type = "DVOR-DME";
                            break;
                        case 8:
                            type = "DVORTAC";
                    }
                    $('#controllerList > ul').append('<li href="#" class="station2" id="' + element2.properties.identifier + '">' + element2.properties.identifier + ' - ' + type + '</li>');
                    navaidsI++;
                }
            });
            if (navaids.length > 10) {
                $('#controllerList > ul').append('<span href="#" class="station2" onclick="moreNavaids()" id="counter">' + "show&nbsp;more..." + '</span>');
            }
        }
        else if (airportsToggle == 'reportingPoints') {
            var reportingPointsI = 0;
            reportingPointsCounter = 10;
            //console.log(navaids);
            //$('#controllerList > ul').append('<p>Test</p>');
            reportingPoints.forEach(element2 => {
                if (reportingPointsI < reportingPointsCounter) {
                    //console.log(element2.properties.identifier);
                    $('#controllerList > ul').append('<li href="#" class="station2" id="' + element2.properties._id + '">' + element2.properties.name + '</li>');
                    reportingPointsI++;
                }
            });
            if (reportingPoints.length > 10) {
                $('#controllerList > ul').append('<span href="#" class="station2" onclick="moreReportingPoints()" id="counter">' + "show&nbsp;more..." + '</span>');
            }
        }
        var stations2 = document.getElementsByClassName("station2");
        for (var i = 0; i < stations2.length; i++) {
            stations2[i].addEventListener('mousedown', function (e) { e.preventDefault(); }, false);
            stations2[i].addEventListener("click", function (e) {

                for (var i = 0; i < stations2.length; i++) {
                    stations2[i].style.color = 'black';
                };
                const xname = this.id;
                $.each(map._layers, function (ml) {
                    if (map._layers[ml].feature && map._layers[ml].feature.mytype == 'airport') {
                        //console.log(e);
                        if (map._layers[ml].feature.properties.name == xname) {
                            //var posX = new L.LatLng(map._layers[ml].feature.properties.geometry.coordinates[1], map._layers[ml].feature.properties.geometry.coordinates[0]);
                            //map.panTo(posX);
                            setTimeout(function () { map._layers[ml].openPopup(); }, 500);
                        }
                    }
                    else if (map._layers[ml].feature && map._layers[ml].feature.mytype == 'navaid') {
                        //console.log(e);
                        if (map._layers[ml].feature.properties.identifier == xname) {
                            setTimeout(function () { map._layers[ml].openPopup(); }, 500);
                        }
                    }
                    else if (map._layers[ml].feature && map._layers[ml].feature.mytype == 'reportingPoint') {
                        //console.log(e);
                        if (map._layers[ml].feature.properties._id == xname) {
                            setTimeout(function () { map._layers[ml].openPopup(); }, 500);
                        }
                    }

                });
            });
        };
    }

    function getMapRadius() {
        var mapBoundNorthEast = map.getBounds().getNorthEast();
        var mapDistance = mapBoundNorthEast.distanceTo(map.getCenter());
        return mapDistance;
    }

    var teleporting = false;

    function getWPData() {
        var mapCenter = map.getCenter();
        //console.log(mapCenter);
        if (teleporting != true) {
            getAirports(mapCenter.lat, mapCenter.lng);
            getNavaids(mapCenter.lat, mapCenter.lng);
            getReportingPoints(mapCenter.lat, mapCenter.lng);
            clearInterval(controllerInterval);
        }
    }

    async function getAirports(lat, lng) {
        airports = [];
        var url = "https://api.core.openaip.net/api/airports?page=1&limit=1000&pos=" + lat + "%2C" + lng + "&dist=" + getMapRadius() + "&sortBy=name&sortDesc=true&approved=true&searchOptLwc=false";
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.setRequestHeader("accept", "application/json");
        xhr.setRequestHeader("x-openaip-client-id", "1d96f836f115bc032c90e9335299e6c3");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                //console.log(xhr.status);
                //console.log(xhr.responseText);
                //console.log(obj);
                var airportsJSON = JSON.parse(xhr.responseText);
                //console.log(airportsJSON);
                for (var airport of airportsJSON.items) {
                    var outGeoJson = {}
                    outGeoJson['properties'] = airport
                    outGeoJson['type'] = "Feature"
                    outGeoJson['geometry'] = airport.geometry
                    outGeoJson['mytype'] = "airport"
                    airports.push(outGeoJson);
                }
                //console.log(airports);
                var label = '';
                var runwayLabels = '';
                var airportElevation = '';
                //console.log('zoooooomlevel: ' + zoomLevel);
                airportMarkers = L.geoJSON(airports, {
                    pointToLayer: function (feature, latlng) {
                        var label = '';
                        var label2 = '';
                        var elevation = '';

                        if (feature.properties.icaoCode) {
                            label += String(feature.properties.icaoCode) + '<br>';
                            label2 += String(feature.properties.icaoCode) + '<br>';
                        }

                        if (feature.properties.name) {
                            label += String(feature.properties.name);
                            label2 += String(feature.properties.name) + '<br>';
                        }

                        var type = '';
                        if (feature.properties.type) {
                            switch (feature.properties.type) {
                                case 0:
                                    type = "Airport (civil/military)";
                                    break;
                                case 1:
                                    type = "Glider Site";
                                    break;
                                case 2:
                                    type = "Airfield Civil";
                                    break;
                                case 3:
                                    type = "International Airport";
                                    break;
                                case 4:
                                    type = "Heliport Military";
                                    break;
                                case 5:
                                    type = "Military Aerodrome";
                                    break;
                                case 6:
                                    type = "Ultra Light Flying Site";
                                    break;
                                case 7:
                                    type = "Heliport Civil";
                                    break;
                                case 8:
                                    type = "Aerodrome Closed";
                                    break;
                                case 9:
                                    type = "Airport resp. Airfield IFR";
                                    break;
                                case 10:
                                    type = "Airfield Water";
                                    break;
                                case 11:
                                    type = "Landing Strip";
                                    break;
                                case 12:
                                    type = "Agricultural Landing Strip";
                                    break;
                                case 13:
                                    type = "Altiport";
                            }
                            //label += String(type) + '<br>';
                            label2 += String(type);
                        }

                        if (feature.properties.elevation.value) {
                            elevation = String(Math.floor(feature.properties.elevation.value * 3.28084));
                            //label += 'Elev: ' + elevation + 'ft' + '<br>';
                        }

                        //console.log(feature.properties.runways);
                        runwayLabels = '';
                        airportElevation = '';
                        airportElevation += elevation + '&apos;';
                        if (feature.properties.runways) {
                            $.each(feature.properties.runways, function (runway) {
                                runwayLabels += String(feature.properties.runways[runway].designator) + '&nbsp;' + '<br>';
                            });
                        };
                        const airportPopup = L.popup({
                            closeOnClick: false,
                            autoClose: true
                        });

                        if (runwayLabels != '') {
                            airportPopup.setContent("<p style='font-size: 1rem'><br>&nbsp;&nbsp;" + label + "&nbsp;&nbsp;</p><p style='font-size: 0.8rem'>" + type + "<br></p><p style='font-size: 0.6rem'> Elevation:<br>" + airportElevation + "<br>Runways: <br>" + runwayLabels + "</p><br><tr><td><span style='margin-top: 15px'><button style='margin-top:0px; text-align: center' class='marker-delete-button' onclick='appendWaypoint(" + latlng.lat + ',' + latlng.lng + ");'>&nbsp;Add WP&nbsp</button></span></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='marker-delete-button' onclick='teleport(" + latlng.lat + ',' + latlng.lng + ")' >&nbsp;Teleport&nbsp;</button></span></tr></td>");
                        }
                        else {
                            airportPopup.setContent("<p style='font-size: 1rem'><br>&nbsp;&nbsp;" + label + "&nbsp;&nbsp;</p><p style='font-size: 0.8rem'>" + type + "<br></p><p style='font-size: 0.6rem'> Elevation:<br>" + airportElevation + "</p><br><tr><td><span style='margin-top: 15px'><button style='margin-top:0px; text-align: center' class='marker-delete-button' onclick='appendWaypoint(" + latlng.lat + ',' + latlng.lng + ");'>&nbsp;Add WP&nbsp;</button></span></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='marker-delete-button' onclick='teleport(" + latlng.lat + ',' + latlng.lng + ")' >&nbsp;Teleport&nbsp;</button></span></tr></td>");
                        }

                        return new L.CircleMarker(latlng, {
                            color: 'transparent',
                            radius: 14,
                        }).bindPopup(airportPopup).bindTooltip(label2).openTooltip().on("popupopen", onPopupOpenAirport);
                    }
                });

                if (map.getZoom() > 9) {
                    if (!map.hasLayer(airportMarkers)) {
                        airportMarkers.addTo(map);
                    }
                }
                else {
                    if (map.hasLayer(airportMarkers)) {
                        map.removeLayer(airportMarkers);
                    }
                }
                if (panelState == 'airports') {
                    listNavaids();
                }
            }
        };
        xhr.send(null);
    }

    async function getNavaids(lat, lng) {
        navaids = [];
        var url = "https://api.core.openaip.net/api/navaids?page=1&limit=1000&pos=" + lat + "%2C" + lng + "&dist=" + getMapRadius() + "&sortBy=name&sortDesc=true&approved=true&searchOptLwc=false";
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.setRequestHeader("accept", "application/json");
        xhr.setRequestHeader("x-openaip-client-id", "1d96f836f115bc032c90e9335299e6c3");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                //console.log(xhr.status);
                //console.log(xhr.responseText);
                //console.log(obj);
                var navaidsJSON = JSON.parse(xhr.responseText);
                //console.log(navaidsJSON);
                for (var navaid of navaidsJSON.items) {
                    var outGeoJson = {}
                    outGeoJson['properties'] = navaid
                    outGeoJson['type'] = "Feature"
                    outGeoJson['geometry'] = navaid.geometry
                    outGeoJson['mytype'] = "navaid"
                    navaids.push(outGeoJson);
                }
                //console.log(navaids);
                navaidMarkers = L.geoJSON(navaids, {
                    pointToLayer: function (feature, latlng) {
                        var label = '';
                        var frequency = '';
                        var identifier = '';

                        if (feature.properties.name) {
                            label = String(feature.properties.name);
                        }


                        if (feature.properties.identifier) {
                            identifier += feature.properties.identifier;
                        }

                        var type = '';
                        if (feature.properties.type) {
                            switch (feature.properties.type) {
                                case 0:
                                    type = "DME";
                                    break;
                                case 1:
                                    type = "TACAN";
                                    break;
                                case 2:
                                    type = "NDB";
                                    break;
                                case 3:
                                    type = "VOR";
                                    break;
                                case 4:
                                    type = "VOR-DME";
                                    break;
                                case 5:
                                    type = "VORTAC";
                                    break;
                                case 6:
                                    type = "DVOR";
                                    break;
                                case 7:
                                    type = "DVOR-DME";
                                    break;
                                case 8:
                                    type = "DVORTAC";
                            }
                            identifier += "<br>" + type;
                        }

                        if (feature.properties.frequency.value) {
                            frequency = feature.properties.frequency.value;
                            identifier += "<br>" + frequency;
                        }

                        var freqUnit = '';
                        if (feature.properties.frequency.unit) {
                            switch (feature.properties.frequency.unit) {
                                case 1:
                                    freqUnit = "kHz";
                                    frequency = Math.ceil(frequency);
                                    break;
                                case 2:
                                    freqUnit = "MHz";
                            }
                            identifier += "&nbsp" + freqUnit;
                        }
                        const navaidPopup = L.popup({
                            closeOnClick: false,
                            autoClose: true,
                        });
                        navaidPopup.setContent("<table><tr><td><p style='font-size: 1.0rem'>" + identifier + "</p></td></tr><tr style='text-align: left;'><td style='text-align: left;'><p style='font-size: 1rem, text-align: left;'></p></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='marker-delete-button' onclick='appendWaypoint(" + latlng.lat + ',' + latlng.lng + ");'>Add WP</button></span></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='marker-delete-button' onclick='teleport(" + latlng.lat + ',' + latlng.lng + ")' >Teleport</button></span></td></tr></table>");
                        return new L.CircleMarker(latlng, {
                            color: 'transparent',
                            radius: 14
                        }).bindPopup(navaidPopup).bindTooltip(identifier).openTooltip().on("popupopen", onPopupOpenNavaid);
                    }
                });

                if (map.getZoom() > 9) {
                    if (!map.hasLayer(navaidMarkers)) {
                        navaidMarkers.addTo(map);
                    }
                }
                else {
                    if (map.hasLayer(navaidMarkers)) {
                        map.removeLayer(navaidMarkers);
                    }
                }

                if (panelState == 'navaids') {
                    listNavaids();
                }
            }
        };
        xhr.send(null);
    }

    async function getReportingPoints(lat, lng) {
        reportingPoints = [];
        var url = "https://api.core.openaip.net/api/reporting-points?page=1&limit=1000&pos=" + lat + "%2C" + lng + "&dist=" + getMapRadius() + "&sortBy=name&sortDesc=true&approved=true&searchOptLwc=false";
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.setRequestHeader("accept", "application/json");
        xhr.setRequestHeader("x-openaip-client-id", "1d96f836f115bc032c90e9335299e6c3");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                //console.log(xhr.status);
                //console.log(xhr.responseText);
                //console.log(obj);
                var reportingPointsJSON = JSON.parse(xhr.responseText);
                //console.log(navaidsJSON);
                for (var reportingPoint of reportingPointsJSON.items) {
                    var outGeoJson = {}
                    outGeoJson['properties'] = reportingPoint
                    outGeoJson['type'] = "Feature"
                    outGeoJson['geometry'] = reportingPoint.geometry
                    outGeoJson['mytype'] = "reportingPoint"
                    reportingPoints.push(outGeoJson);
                }
                //console.log(reportingPoints);
                reportingPointMarkers = L.geoJSON(reportingPoints, {
                    pointToLayer: function (feature, latlng) {
                        var label = '';
                        var identifier = '';

                        if (feature.properties.name) {
                            label = String(feature.properties.name);
                        }

                        if (feature.properties.name) {
                            label = String(feature.properties.name);
                        }

                        if (feature.properties.id) {
                            identifier = feature.properties.id;
                        }

                        const reportingPointPopup = L.popup({
                            closeOnClick: false,
                            autoClose: true,
                        });
                        reportingPointPopup.setContent("<table><tr><td><p style='font-size: 1.0rem'>" + label + "</p></td></tr><tr style='text-align: left;'><td style='text-align: left;'><p style='font-size: 1rem, text-align: left;'></p></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='marker-delete-button' onclick='appendWaypoint(" + latlng.lat + ',' + latlng.lng + ");'>Add WP</button></span></td></tr><br><tr><td><span style='margin-top: 15px'><button style='margin-top:10px; text-align: center' class='marker-delete-button' onclick='teleport(" + latlng.lat + ',' + latlng.lng + ")' >Teleport</button></span></td></tr></table>");
                        return new L.CircleMarker(latlng, {
                            color: 'transparent',
                            radius: 14
                        }).bindPopup(reportingPointPopup).bindTooltip(label).openTooltip().on("popupopen", onPopupOpenReportingPoint);
                    }
                });

                if (map.getZoom() > 9) {
                    if (!map.hasLayer(reportingPointMarkers)) {
                        reportingPointMarkers.addTo(map);
                    }
                }
                else {
                    if (map.hasLayer(reportingPointMarkers)) {
                        map.removeLayer(reportingPointMarkers);
                    }
                }

                if (panelState == 'reportingPoints') {
                    listNavaids();
                }
            }
        };
        xhr.send(null);
    }


    function onPopupOpenAirport(e) {
        //console.log(this);
        tempWPName = this.feature.properties.name;
        if (this.feature.properties.icaoCode) {
            tempWPName = this.feature.properties.icaoCode;
        }
        //console.log(tempWPName);
        switch (this.feature.properties.type) {
            case 0:
                tempWPType = "Airport (civil/military)";
                break;
            case 1:
                tempWPType = "Glider Site";
                break;
            case 2:
                tempWPType = "Airfield Civil";
                break;
            case 3:
                tempWPType = "International Airport";
                break;
            case 4:
                tempWPType = "Heliport Military";
                break;
            case 5:
                tempWPType = "Military Aerodrome";
                break;
            case 6:
                tempWPType = "Ultra Light Flying Site";
                break;
            case 7:
                tempWPType = "Heliport Civil";
                break;
            case 8:
                tempWPType = "Aerodrome Closed";
                break;
            case 9:
                tempWPType = "Airport resp. Airfield IFR";
                break;
            case 10:
                tempWPType = "Airfield Water";
                break;
            case 11:
                tempWPType = "Landing Strip";
                break;
            case 12:
                tempWPType = "Agricultural Landing Strip";
                break;
            case 13:
                tempWPType = "Altiport";
        }
        //console.log(tempWPType);
        polylinepoints = [];
        polyline = [];
        follow = false;
        toggle.enable();
        if (map.hasLayer(polyline)) {
            map.removeLayer(polyline);
        }
        map.setView(e.target._popup._latlng, e.target._zoom);
    }

    function onPopupOpenNavaid(e) {
        //console.log(this);
        tempWPName = this.feature.properties.identifier;
        //console.log(tempWPName);
        switch (this.feature.properties.type) {
            case 0:
                tempWPType = "DME";
                break;
            case 1:
                tempWPType = "TACAN";
                break;
            case 2:
                tempWPType = "NDB";
                break;
            case 3:
                tempWPType = "VOR";
                break;
            case 4:
                tempWPType = "VOR-DME";
                break;
            case 5:
                tempWPType = "VORTAC";
                break;
            case 6:
                tempWPType = "DVOR";
                break;
            case 7:
                tempWPType = "DVOR-DME";
                break;
            case 8:
                tempWPType = "DVORTAC";
        }
        var frequency = this.feature.properties.frequency.value;
        var freqUnit;
        switch (this.feature.properties.frequency.unit) {
            case 1:
                freqUnit = "kHz";
                frequency = Math.ceil(frequency);
                break;
            case 2:
                freqUnit = "MHz";
        }
        tempWPType += '&nbsp;' + frequency + '&nbsp;' + freqUnit;
        //console.log(tempWPType);
        polylinepoints = [];
        polyline = [];
        follow = false;
        toggle.enable();
        if (map.hasLayer(polyline)) {
            map.removeLayer(polyline);
        }
        map.setView(e.target._popup._latlng, e.target._zoom);
    }

    function onPopupOpenReportingPoint(e) {
        //console.log(this);
        tempWPName = this.feature.properties.name;
        //console.log(tempWPName);
        tempWPType = 'reportingPoint';
        //console.log(tempWPType);
        polylinepoints = [];
        polyline = [];
        follow = false;
        toggle.enable();
        if (map.hasLayer(polyline)) {
            map.removeLayer(polyline);
        }
        map.setView(e.target._popup._latlng, e.target._zoom);
    }

    function appendWaypoint(lat, lng) {
        wpNames.push(tempWPName);
        wpTypes.push(tempWPType);
        altitudes.push('0');
        var latlngPoint = new L.LatLng(lat, lng);
        map.fireEvent('click', {
            latlng: latlngPoint
        });
        wpNum++;
    };


    // Keyboard
    var id2 = '';
    var saveVal;
    var textstart = '';
    var textend = '';
    var capslock = false;
    const Keyboard = {
        elements: {
            main: null,
            keysContainer: null,
            keys: []
        },
        eventHandlers: {
            oninput: null,
            //onclose: null
        },
        properties: {
            value: "",
            capsLock: false
        },
        init() {
            // Create main elements
            this.elements.main = document.createElement("div");
            this.elements.main.setAttribute("id", "keyboard");
            this.elements.keysContainer = document.createElement("div");
            this.elements.keysContainer.setAttribute("id", "keyContainer");
            // Setup main elements
            this.elements.main.classList.add("keyboard", "keyboard--hidden");
            this.elements.keysContainer.classList.add("keyboard__keys");
            this.elements.keysContainer.appendChild(this._createKeys());
            this.elements.keys = this.elements.keysContainer.querySelectorAll(".keyboard__key");
            // Add to DOM
            this.elements.main.appendChild(this.elements.keysContainer);
            document.getElementById("keyb").appendChild(this.elements.main);
            // Automatically use keyboard for elements with .use-keyboard-input
            document.querySelectorAll(".glass ").forEach(element => {
                element.addEventListener("focus", () => {
                    id = element.id;
                    //console.log(id + ' focused');
                    textstart = '';
                    textend = '';
                    map.closePopup();
                });
                element.addEventListener("click", () => {
                    document.getElementById("keyb").style.visibility = "visible";
                    this.open(element.value, currentValue => {
                        element.value = currentValue;
                    });
                    var text = element.value;
                    textstart = text.slice(0, element.selectionStart);
                    textend = text.slice(element.selectionEnd, element.value.length);
                    this.properties.value = textstart;
                    getCursorpos();
                });
                element.addEventListener("select", () => {
                    this.open(element.value, currentValue => {
                        element.value = currentValue;
                    });
                    var text = element.value;
                    textstart = text.slice(0, element.selectionStart);
                    textend = text.slice(element.selectionEnd, element.value.length);
                    this.properties.value = textstart;
                });
            });
        },
        _createKeys() {
            const fragment = document.createDocumentFragment();
            const keyLayout = [
                "rwy", "sqwk", "ent", "fl", "clear",
                "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", ".", "backspace",
                "q", "w", "e", "r", "t", "y", "u", "i", "o", "p",
                "a", "s", "d", "f", "g", "h", "j", "k", "l", "enter",
                "caps", "z", "x", "c", "v", "b", "n", "m",
                "done", "space", "clearAll",
            ];
            // Creates HTML for an icon
            const createIconHTML = (icon_name) => {
                return `<i class="material-icons">${icon_name}</i>`;
            };
            keyLayout.forEach(key => {
                const keyElement = document.createElement("button");
                const insertLineBreak = ["clear", "backspace", "p", "enter", "m"].indexOf(key) !== -1;
                // Add attributes/classes
                keyElement.setAttribute("type", "button");
                keyElement.classList.add("keyboard__key");
                switch (key) {
                    case "backspace":
                        keyElement.classList.add("keyboard__key--wide");
                        keyElement.innerHTML = createIconHTML("Bksp");
                        keyElement.addEventListener("click", () => {
                            if (window.getSelection().toString() == '') {
                                this.properties.value = this.properties.value.substring(0, this.properties.value.length - 1);
                                if (cursorPos <= -1) {
                                    cursorPos = 0;
                                    var targetTextarea = document.getElementsByTagName("input")[0];
                                    targetTextarea.focus();
                                    setCaretToPos(targetTextarea, 0)
                                    var text = targetTextarea.value;
                                    textstart = '';
                                    textend = text.slice(0, targetTextarea.value.length);
                                    //return;
                                }
                                else {
                                    cursorPos = cursorPos - 1;
                                }
                            }
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "caps":
                        keyElement.classList.add("keyboard__key--wide", "keyboard__key--activatable");
                        keyElement.innerHTML = createIconHTML("Shift");
                        keyElement.addEventListener("click", () => {
                            this._toggleCapsLock();
                            keyElement.classList.toggle("keyboard__key--active", this.properties.capsLock);
                        });
                        break;
                    case "enter":
                        keyElement.classList.add("keyboard__key--wide");
                        keyElement.innerHTML = createIconHTML("Enter");
                        keyElement.addEventListener("click", () => {
                            if (metarSearchExpandet == true) {
                                document.getElementById("boton").click();
                            }
                            this.properties.value += "\n";
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "space":
                        keyElement.classList.add("keyboard__key--extra-wide");
                        keyElement.innerHTML = createIconHTML("Space");

                        keyElement.addEventListener("click", () => {
                            this.properties.value += " ";
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "done":
                        keyElement.classList.add("keyboard__key--wide", "keyboard__key--dark");
                        keyElement.innerHTML = createIconHTML("Close");
                        keyElement.addEventListener("click", () => {
                            var x = document.getElementById("keyboard");
                            x.style.display = "none";
                            showWpList();
                            clearTimeout(popupTimeout);
                            popupTimeout = setTimeout(function () { map.closePopup(); }, 5000);
                        });
                        break;
                    case "rwy":
                        keyElement.classList.add("keyboard__key--spezial", "keyboard__key--dark");
                        keyElement.innerHTML = createIconHTML("RWY");
                        keyElement.addEventListener("click", () => {
                            this.properties.value += "Runway: ";
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "sqwk":
                        keyElement.classList.add("keyboard__key--spezial", "keyboard__key--dark");
                        keyElement.innerHTML = createIconHTML("SQWK");
                        keyElement.addEventListener("click", () => {
                            this.properties.value += "Squawk: ";
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "ent":
                        keyElement.classList.add("keyboard__key--spezial", "keyboard__key--dark");
                        keyElement.innerHTML = createIconHTML("ENTR");
                        keyElement.addEventListener("click", () => {
                            this.properties.value += "Entry: ";
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "fl":
                        keyElement.classList.add("keyboard__key--spezial", "keyboard__key--dark");
                        keyElement.innerHTML = createIconHTML("FL");
                        keyElement.addEventListener("click", () => {
                            this.properties.value += "Flightlevel: ";
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "clear":
                        keyElement.classList.add("keyboard__key--spezial", "keybord__key--clear");
                        keyElement.innerHTML = createIconHTML("Clear");
                        keyElement.addEventListener("click", () => {
                            this.properties.value = "";
                            this._triggerEvent("oninput");
                        });
                        break;
                    case "clearAll":
                        keyElement.classList.add("keyboard__key--wide", "keybord__key--clear");
                        keyElement.innerHTML = createIconHTML("Reset");
                        keyElement.addEventListener("click", () => {

                        });
                        break;
                    default:
                        keyElement.textContent = key.toLowerCase();
                        keyElement.addEventListener("click", () => {
                            if (capslock == true) {
                                if (key == 1) {
                                    this.properties.value += "-";
                                }
                                else if (key == 2) {
                                    this.properties.value += "+";
                                }
                                else if (key == 3) {
                                    this.properties.value += "\xB0";
                                }
                                else if (key == 4) {
                                    this.properties.value += "'";
                                }
                                else if (key == 5) {
                                    this.properties.value += "''";
                                }
                                else if (key == 6) {
                                    this.properties.value += "(";
                                }
                                else if (key == 7) {
                                    this.properties.value += ")";
                                }
                                else if (key == 8) {
                                    this.properties.value += "/";
                                }
                                else if (key == 9) {
                                    this.properties.value += "!";
                                }
                                else if (key == 0) {
                                    this.properties.value += ":";
                                }
                                else if (key == ".") {
                                    this.properties.value += ".";
                                }
                                else {
                                    this.properties.value += this.properties.capsLock ? key.toUpperCase() : key.toLowerCase();
                                }
                            }
                            else {
                                this.properties.value += this.properties.capsLock ? key.toUpperCase() : key.toLowerCase();
                            }
                            cursorPos = cursorPos + 1;
                            this._triggerEvent("oninput");
                            keyPress(key);
                        });
                        break;
                }
                fragment.appendChild(keyElement);
                if (insertLineBreak) {
                    fragment.appendChild(document.createElement("br"));
                }
            });
            return fragment;
        },
        _triggerEvent(handlerName) {
            if (typeof this.eventHandlers[handlerName] == "function") {
                //cursorPos = this.properties.value.length;
                this.eventHandlers[handlerName](this.properties.value + textend);
                var targetTextarea = document.getElementsByTagName("input")[0];
                setCaretToPos(targetTextarea, cursorPos);
                textend = targetTextarea.value.slice(cursorPos, targetTextarea.value.length);
                setWPname();
            }
        },
        _toggleCapsLock() {
            capslock = !capslock;
            this.properties.capsLock = !this.properties.capsLock;
            for (const key of this.elements.keys) {
                if (key.childElementCount === 0) {
                    key.textContent = this.properties.capsLock ? key.textContent.toUpperCase() : key.textContent.toLowerCase();
                    this.properties.capsLock ? keyContSpecial() : keyContNormal();
                    function keyContSpecial() {
                        if (key.textContent == 1) {
                            key.textContent = "-";
                        }
                        if (key.textContent == 2) {
                            key.textContent = "+";
                        }
                        if (key.textContent == 3) {
                            key.textContent = "\xB0";
                        }
                        if (key.textContent == 4) {
                            key.textContent = "'";
                        }
                        if (key.textContent == 5) {
                            key.textContent = "''";
                        }
                        if (key.textContent == 6) {
                            key.textContent = "(";
                        }
                        if (key.textContent == 7) {
                            key.textContent = ")";
                        }
                        if (key.textContent == 8) {
                            key.textContent = "/";
                        }
                        if (key.textContent == 9) {
                            key.textContent = "!";
                        }
                        if (key.textContent == 0) {
                            key.textContent = ":";
                        }
                        if (key.textContent == ".") {
                            key.textContent = ".";
                        }
                    }
                    function keyContNormal() {
                        if (key.textContent == "-") {
                            key.textContent = 1;
                        }
                        if (key.textContent == "+") {
                            key.textContent = 2;
                        }
                        if (key.textContent == "\xB0") {
                            key.textContent = 3;
                        }
                        if (key.textContent == "'") {
                            key.textContent = 4;
                        }
                        if (key.textContent == "''") {
                            key.textContent = 5;
                        }
                        if (key.textContent == "(") {
                            key.textContent = 6;
                        }
                        if (key.textContent == ")") {
                            key.textContent = 7;
                        }
                        if (key.textContent == "/") {
                            key.textContent = 8;
                        }
                        if (key.textContent == "!") {
                            key.textContent = 9;
                        }
                        if (key.textContent == ":") {
                            key.textContent = 0;
                        }
                        if (key.textContent == ".") {
                            key.textContent = ".";
                        }
                    }
                }
            }
        },
        open(initialValue, oninput/*, onclose*/) {
            this.properties.value = initialValue || "";
            this.eventHandlers.oninput = oninput;
            this.elements.main.classList.remove("keyboard--hidden");
            var x = document.getElementById("keyboard");
            x.style.display = "block";
            var x2 = document.getElementById("keyContainer");
            x2.style.display = "block";
            hideWpList();
            // focus on the input element
            const input = document.getElementsByTagName("input")[0];
            input.focus();
            clearTimeout(popupTimeout);
        },
        close() {
            this.properties.value = "";
            this.eventHandlers.oninput = oninput;
            this.elements.main.classList.add("keyboard--hidden");
            var x = document.getElementById("keyboard");
            x.style.display = "none";
            var x2 = document.getElementById("keyContainer");
            x2.style.display = "none";
            showWpList();
        }
    };

    function keyPress(char) {
        // get the element in question
        const input = document.getElementsByTagName("input")[0];
        // focus on the input element
        input.focus();

        // add event listeners to the input element
        input.addEventListener('keypress', (event) => {
            //console.log("You have pressed key: ", event.key);
        });

        input.addEventListener('keydown', (event) => {
            //console.log(`key: ${event.key} has been pressed down`);
        });

        input.addEventListener('keyup', (event) => {
            //console.log(`key: ${event.key} has been released`);
        });

        // dispatch keyboard events
        input.dispatchEvent(new KeyboardEvent('keypress', { 'key': char }));
        input.dispatchEvent(new KeyboardEvent('keydown', { 'key': char }));
        input.dispatchEvent(new KeyboardEvent('keyup', { 'key': char }));
    }


    const box = document.querySelector('#keyb');
    box.addEventListener('click', function (e) {
        e.stopPropagation();
    });
    box.addEventListener('dblclick', function (e) {
        e.stopPropagation();
    });
</script>

</html>
